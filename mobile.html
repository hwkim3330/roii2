<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ROii2 Mobile - TSN Network Simulator</title>

    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            width: 100%; height: 100%; overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f4f8;
            color: #1e293b;
        }
        #canvas3d { width: 100%; height: 100%; position: fixed; top: 0; left: 0; }

        .hud { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 100%);
        }

        .version-links {
            display: flex;
            gap: 6px;
            pointer-events: auto;
            flex-wrap: wrap;
        }
        .version-link {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 11px;
            color: #475569;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .version-link.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        .stats-bar {
            display: flex;
            gap: 12px;
            background: white;
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat { text-align: center; }
        .stat-value { font-size: 16px; font-weight: 700; color: #3b82f6; }
        .stat-label { font-size: 9px; color: #64748b; text-transform: uppercase; }

        /* Speedometer */
        .speedometer {
            position: absolute;
            top: 70px;
            right: 12px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .speed-value { font-size: 40px; font-weight: 700; color: #10b981; line-height: 1; }
        .speed-unit { font-size: 11px; color: #64748b; margin-top: 2px; }

        /* Touch Controls */
        .touch-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            display: flex;
            justify-content: space-between;
            padding: 12px;
            pointer-events: auto;
            background: linear-gradient(to top, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 100%);
        }

        .joystick-area {
            width: 140px;
            height: 140px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            position: relative;
            border: 2px solid rgba(59, 130, 246, 0.3);
        }
        .joystick-knob {
            width: 56px;
            height: 56px;
            background: #3b82f6;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .pedals {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .pedal {
            width: 90px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            gap: 6px;
            border: none;
            cursor: pointer;
        }
        .pedal-gas {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .pedal-brake {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .pedal.active { transform: scale(0.95); opacity: 0.8; }

        /* Action Buttons */
        .action-buttons {
            position: absolute;
            bottom: 200px;
            right: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: auto;
        }
        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #475569;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .action-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        /* Fault Panel */
        .fault-panel {
            position: absolute;
            left: 12px;
            bottom: 200px;
            background: white;
            padding: 14px;
            border-radius: 12px;
            width: 260px;
            pointer-events: auto;
            display: none;
            border: 1px solid #fecaca;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
        }
        .fault-panel.visible { display: block; }
        .fault-title { font-size: 12px; font-weight: 600; color: #dc2626; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .fault-item {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .fault-item.active { background: #fecaca; border-color: #f87171; }
        .fault-name { font-size: 11px; font-weight: 600; color: #b91c1c; }
        .fault-desc { font-size: 10px; color: #64748b; margin-top: 2px; }

        /* Properties Panel */
        .properties {
            position: absolute;
            right: 0;
            top: 0;
            width: 280px;
            height: 100%;
            background: white;
            border-left: 1px solid #e2e8f0;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 100;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
        }
        .properties.visible { transform: translateX(0); }
        .properties-header {
            height: 50px;
            padding: 0 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .properties-title { font-size: 13px; font-weight: 600; color: #1e293b; }
        .close-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            color: #64748b;
            font-size: 12px;
        }
        .properties-content { padding: 16px; overflow-y: auto; flex: 1; }
        .prop-section { margin-bottom: 16px; }
        .prop-title {
            font-size: 9px;
            font-weight: 700;
            color: #3b82f6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; font-size: 10px; font-weight: 600; color: #475569; margin-bottom: 4px; }
        .form-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 12px;
            color: #1e293b;
        }
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
        }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .badge-danger { background: #fee2e2; color: #dc2626; }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            padding: 14px 24px;
            background: #1e293b;
            color: white;
            border-radius: 10px;
            font-weight: 500;
            font-size: 13px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* Landscape */
        @media (orientation: landscape) {
            .touch-controls { height: 150px; }
            .joystick-area { width: 120px; height: 120px; }
            .joystick-knob { width: 48px; height: 48px; }
            .pedal { width: 80px; height: 50px; font-size: 12px; }
            .speedometer { top: 60px; padding: 10px 16px; }
            .speed-value { font-size: 32px; }
            .action-buttons { bottom: 170px; }
            .fault-panel { bottom: 170px; width: 240px; }
        }
    </style>
</head>
<body>
    <div id="canvas3d"></div>

    <div class="hud">
        <div class="top-bar">
            <div class="version-links">
                <a href="index.html" class="version-link"><i class="fas fa-project-diagram"></i> Network</a>
                <a href="drive.html" class="version-link"><i class="fas fa-gamepad"></i> Drive</a>
                <a href="mobile.html" class="version-link active"><i class="fas fa-mobile-alt"></i> Mobile</a>
            </div>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="deviceCount">0</div>
                    <div class="stat-label">Devices</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="linkCount">0</div>
                    <div class="stat-label">Links</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="bandwidth">0</div>
                    <div class="stat-label">Gbps</div>
                </div>
            </div>
        </div>

        <div class="speedometer">
            <div class="speed-value" id="speedValue">0</div>
            <div class="speed-unit">km/h</div>
        </div>

        <div class="action-buttons">
            <div class="action-btn" id="faultBtn" title="Fault"><i class="fas fa-bolt"></i></div>
            <div class="action-btn" id="cameraBtn" title="Camera"><i class="fas fa-video"></i></div>
            <div class="action-btn" id="resetBtn" title="Reset"><i class="fas fa-redo"></i></div>
        </div>

        <div class="touch-controls">
            <div class="joystick-area" id="joystick">
                <div class="joystick-knob" id="knob"></div>
            </div>
            <div class="pedals">
                <button class="pedal pedal-gas" id="gasBtn"><i class="fas fa-arrow-up"></i> GAS</button>
                <button class="pedal pedal-brake" id="brakeBtn"><i class="fas fa-stop"></i> BRAKE</button>
            </div>
        </div>

        <div class="fault-panel" id="faultPanel">
            <div class="fault-title"><i class="fas fa-exclamation-triangle"></i> Fault Injection</div>
            <div class="fault-item" data-fault="front-backbone">
                <div class="fault-name">Front 10G Backbone Error</div>
                <div class="fault-desc">Front-L <i class="fas fa-arrows-alt-h"></i> Front-R link failure</div>
            </div>
            <div class="fault-item" data-fault="front-l-link">
                <div class="fault-name">Front-L <i class="fas fa-arrow-right"></i> HPC Error</div>
                <div class="fault-desc">Front-L zone controller link failure</div>
            </div>
            <div class="fault-item" data-fault="sensor">
                <div class="fault-name"><i class="fas fa-satellite-dish"></i> LiDAR-FL Sensor</div>
                <div class="fault-desc">Front-left LiDAR malfunction</div>
            </div>
        </div>

        <div class="properties" id="properties">
            <div class="properties-header">
                <div class="properties-title">Device Properties</div>
                <button class="close-btn" id="closeBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="properties-content" id="propertiesContent">
                <p style="color: #94a3b8; text-align: center; padding: 20px;">
                    <i class="fas fa-mouse-pointer" style="font-size: 20px; display: block; margin-bottom: 8px;"></i>
                    Tap device to view
                </p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    // ROii2 Mobile - Full Sensor Configuration + Mouse Support

    // === THREE.JS ===
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f4f8);
    scene.fog = new THREE.Fog(0xf0f4f8, 100, 350);

    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 500);

    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('canvas3d').appendChild(renderer.domElement);

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // === LIGHTING ===
    scene.add(new THREE.AmbientLight(0xFFFFFF, 0.8));
    const mainLight = new THREE.DirectionalLight(0xFFFFFF, 0.9);
    mainLight.position.set(30, 60, 30);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 2048;
    mainLight.shadow.mapSize.height = 2048;
    scene.add(mainLight);

    // === ENVIRONMENT ===
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(1000, 1000),
        new THREE.MeshStandardMaterial({ color: 0xe2e8f0, roughness: 0.8 })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -0.5;
    ground.receiveShadow = true;
    scene.add(ground);

    // Road
    const roadGroup = new THREE.Group();
    const road = new THREE.Mesh(
        new THREE.PlaneGeometry(35, 2000),
        new THREE.MeshStandardMaterial({ color: 0x475569, roughness: 0.7 })
    );
    road.rotation.x = -Math.PI / 2;
    road.position.y = -0.1;
    roadGroup.add(road);

    for (let i = -500; i < 500; i += 20) {
        const line = new THREE.Mesh(
            new THREE.PlaneGeometry(0.3, 10),
            new THREE.MeshBasicMaterial({ color: 0xffffff })
        );
        line.rotation.x = -Math.PI / 2;
        line.position.set(0, 0.01, i);
        roadGroup.add(line);
    }
    scene.add(roadGroup);

    // Grid
    const grid = new THREE.GridHelper(300, 60, 0x3b82f6, 0xc4d4e8);
    grid.material.opacity = 0.3;
    grid.material.transparent = true;
    scene.add(grid);

    // === STATE ===
    const state = {
        vehicleGroup: new THREE.Group(),
        devices: new Map(),
        connections: [],
        deviceCounter: 1,
        activeFaults: new Set(),
        cameraMode: 0
    };
    scene.add(state.vehicleGroup);

    const drive = {
        speed: 0,
        maxSpeed: 2.0,
        acceleration: 0.05,
        steerInput: 0,
        steering: 0
    };

    const input = {
        gas: false,
        brake: false,
        joystickActive: false,
        joystickX: 0,
        joystickY: 0
    };

    // === TEMPLATES ===
    const templates = {
        lan9692: { label: 'LAN9692', color: 0x10b981, size: [4, 2, 4], ports: 12 },
        hpc: { label: 'HPC', color: 0xe11d48, size: [5, 2.5, 5], ports: 4 },
        camera: { label: 'Camera', color: 0xf59e0b, size: [0.8, 0.8, 0.8], ports: 1 },
        lidar: { label: 'LiDAR', color: 0x10b981, size: [1.2, 1.2, 1.2], ports: 1 },
        radar: { label: 'Radar', color: 0x8b5cf6, size: [1.2, 1.2, 1.2], ports: 1 }
    };

    // === VEHICLE ===
    let vehicleMeshes = [];

    function createVehicle() {
        const loader = new THREE.GLTFLoader();
        loader.load('./roii.glb',
            (gltf) => {
                const model = gltf.scene;
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                const scale = 35 / Math.max(size.x, size.y, size.z);
                model.scale.set(scale, scale, scale);
                model.position.set(-center.x, -center.y + size.y * scale * 0.5 + 0.5, -center.z);
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material.transparent = true;
                        child.material.opacity = 0.75;
                        child.castShadow = true;
                        vehicleMeshes.push(child);
                    }
                });
                state.vehicleGroup.add(model);
            },
            null,
            () => {
                const chassis = new THREE.Mesh(
                    new THREE.BoxGeometry(14, 8, 32),
                    new THREE.MeshPhysicalMaterial({ color: 0xe2e8f0, transparent: true, opacity: 0.75, metalness: 0.1, roughness: 0.3 })
                );
                chassis.position.y = 5;
                chassis.castShadow = true;
                state.vehicleGroup.add(chassis);
                vehicleMeshes.push(chassis);
            }
        );
    }

    // === DEVICES & CONNECTIONS ===
    function addDevice(type, position, label) {
        const t = templates[type];
        const id = `dev-${state.deviceCounter++}`;
        const device = { id, type, label, position: position.clone(), status: 'normal', mesh: null };

        const geo = type === 'lidar' && !label.includes('Center') ?
            new THREE.CylinderGeometry(t.size[0] * 0.5, t.size[0] * 0.5, t.size[1], 16) :
            new THREE.BoxGeometry(...t.size);

        const mat = new THREE.MeshPhongMaterial({
            color: t.color, emissive: t.color, emissiveIntensity: 0.4, shininess: 30
        });

        const group = new THREE.Group();
        const mesh = new THREE.Mesh(geo, mat);
        mesh.castShadow = true;
        group.add(mesh);
        group.add(new THREE.LineSegments(
            new THREE.EdgesGeometry(geo),
            new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.6, transparent: true })
        ));
        group.position.copy(position);
        group.userData = { device };
        device.mesh = group;

        state.vehicleGroup.add(group);
        state.devices.set(id, device);
        return device;
    }

    function createConnection(from, to) {
        // Determine bandwidth and color based on connection type
        let bw, color, tubeRadius;
        if (from.type === 'lan9692' && to.type === 'lan9692') {
            bw = '10G';
            color = 0x3b82f6; // Blue for 10G backbone
            tubeRadius = 0.15;
        } else if (from.type === 'hpc' || to.type === 'hpc') {
            bw = '10G';
            color = 0xfbbf24; // Gold for HPC links
            tubeRadius = 0.12;
        } else {
            bw = '1G';
            color = 0x10b981; // Green for sensor links
            tubeRadius = 0.06;
        }

        const curve = new THREE.CatmullRomCurve3([from.position.clone(), to.position.clone()]);
        const tube = new THREE.Mesh(
            new THREE.TubeGeometry(curve, 12, tubeRadius, 6, false),
            new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.7 })
        );
        state.vehicleGroup.add(tube);

        const particles = [];
        const particleCount = bw === '10G' ? 4 : 2;
        const particleSize = bw === '10G' ? 0.18 : 0.1;
        for (let i = 0; i < particleCount; i++) {
            const p = new THREE.Mesh(
                new THREE.SphereGeometry(particleSize, 6, 6),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );
            p.userData = { t: i / particleCount, curve };
            state.vehicleGroup.add(p);
            particles.push(p);
        }

        const conn = { from, to, tube, curve, particles, status: 'normal', originalColor: color, bandwidth: bw };
        state.connections.push(conn);
        return conn;
    }

    function updateConnectionVisual(conn, status) {
        conn.status = status;
        if (status === 'fault') {
            conn.tube.material.color.setHex(0xef4444);
            conn.tube.material.opacity = 0.3;
            conn.particles.forEach(p => p.visible = false);
        } else {
            conn.tube.material.color.setHex(conn.originalColor);
            conn.tube.material.opacity = 0.7;
            conn.particles.forEach(p => p.visible = true);
        }
    }

    // === LOAD FULL SCENARIO (17 Sensors) ===
    function loadScenario() {
        createVehicle();

        // === CENTRAL HPC ===
        const acuIT = addDevice('hpc', new THREE.Vector3(0, 4, 0), 'ACU_IT');

        // === ZONE CONTROLLERS (3x LAN9692) ===
        const frontL = addDevice('lan9692', new THREE.Vector3(-3.5, 4, 10), 'Front-L-9692');
        const frontR = addDevice('lan9692', new THREE.Vector3(3.5, 4, 10), 'Front-R-9692');
        const rear = addDevice('lan9692', new THREE.Vector3(0, 4, -10), 'Rear-9692');

        // === SENSORS (17 total) ===
        // LiDAR (4)
        const lidarFL = addDevice('lidar', new THREE.Vector3(-7.5, 12, 16), 'LiDAR-FL');
        const lidarFR = addDevice('lidar', new THREE.Vector3(7.5, 12, 16), 'LiDAR-FR');
        const lidarFC = addDevice('lidar', new THREE.Vector3(0, 7, 18), 'LiDAR-Front-Center');
        const lidarRC = addDevice('lidar', new THREE.Vector3(0, 7, -18), 'LiDAR-Rear-Center');

        // Camera (8)
        const camFC = addDevice('camera', new THREE.Vector3(0, 13, 17.5), 'Cam-Front-Center');
        const camFL = addDevice('camera', new THREE.Vector3(-1, 13, 17.5), 'Cam-Front-L');
        const camFR = addDevice('camera', new THREE.Vector3(1, 13, 17.5), 'Cam-Front-R');
        const camSL1 = addDevice('camera', new THREE.Vector3(-7.5, 13, 16), 'Cam-Side-L1');
        const camSR1 = addDevice('camera', new THREE.Vector3(7.5, 13, 16), 'Cam-Side-R1');
        const camSL2 = addDevice('camera', new THREE.Vector3(-7.5, 13, -16), 'Cam-Side-L2');
        const camSR2 = addDevice('camera', new THREE.Vector3(7.5, 13, -16), 'Cam-Side-R2');
        const camRC = addDevice('camera', new THREE.Vector3(0, 11, -17.5), 'Cam-Rear-Center');

        // Radar (5)
        const radarFC = addDevice('radar', new THREE.Vector3(0, 5, 18), 'Radar-Front-Center');
        const radarFL = addDevice('radar', new THREE.Vector3(-6.5, 5, 17), 'Radar-Front-L');
        const radarFR = addDevice('radar', new THREE.Vector3(6.5, 5, 17), 'Radar-Front-R');
        const radarRL = addDevice('radar', new THREE.Vector3(-6.5, 5, -17), 'Radar-Rear-L');
        const radarRR = addDevice('radar', new THREE.Vector3(6.5, 5, -17), 'Radar-Rear-R');

        // === CONNECTIONS ===
        createConnection(frontL, acuIT);
        createConnection(frontR, acuIT);
        createConnection(rear, acuIT);
        createConnection(frontL, frontR); // 10G backbone

        createConnection(frontL, lidarFL);
        createConnection(frontL, lidarFC);
        createConnection(frontL, camFL);
        createConnection(frontL, camSL1);
        createConnection(frontL, radarFL);

        createConnection(frontR, lidarFR);
        createConnection(frontR, camFC);
        createConnection(frontR, camFR);
        createConnection(frontR, camSR1);
        createConnection(frontR, radarFC);
        createConnection(frontR, radarFR);

        createConnection(rear, lidarRC);
        createConnection(rear, camRC);
        createConnection(rear, camSL2);
        createConnection(rear, camSR2);
        createConnection(rear, radarRL);
        createConnection(rear, radarRR);

        updateStats();
        showToast('17 Sensors loaded!');
    }

    function updateStats() {
        document.getElementById('deviceCount').textContent = state.devices.size;
        document.getElementById('linkCount').textContent = state.connections.length;
        // Calculate total bandwidth
        let totalBW = 0;
        state.connections.forEach(c => {
            totalBW += c.bandwidth === '10G' ? 10 : 1;
        });
        document.getElementById('bandwidth').textContent = totalBW;
    }

    // === FAULT SIMULATION ===
    function injectFault(faultType) {
        if (state.activeFaults.has(faultType)) {
            state.activeFaults.delete(faultType);
            state.connections.forEach(conn => updateConnectionVisual(conn, 'normal'));
            state.devices.forEach(d => {
                if (d.label === 'LiDAR-FL' && d.status === 'fault') {
                    d.status = 'normal';
                    d.mesh.children[0].material.color.setHex(templates.lidar.color);
                    d.mesh.children[0].material.emissive.setHex(templates.lidar.color);
                }
            });
            document.querySelector(`[data-fault="${faultType}"]`)?.classList.remove('active');
            showToast('Fault cleared');
            return;
        }

        state.activeFaults.add(faultType);

        if (faultType === 'sensor') {
            state.devices.forEach(d => {
                if (d.label === 'LiDAR-FL') {
                    d.status = 'fault';
                    d.mesh.children[0].material.color.setHex(0xef4444);
                    d.mesh.children[0].material.emissive.setHex(0xef4444);
                }
            });
        } else {
            state.connections.forEach(conn => {
                let match = false;
                if (faultType === 'front-backbone' &&
                    ((conn.from.label === 'Front-L-9692' && conn.to.label === 'Front-R-9692') ||
                     (conn.from.label === 'Front-R-9692' && conn.to.label === 'Front-L-9692'))) {
                    match = true;
                }
                if (faultType === 'front-l-link' &&
                    ((conn.from.label === 'Front-L-9692' && conn.to.label === 'ACU_IT') ||
                     (conn.from.label === 'ACU_IT' && conn.to.label === 'Front-L-9692'))) {
                    match = true;
                }
                if (match) updateConnectionVisual(conn, 'fault');
            });
        }

        document.querySelector(`[data-fault="${faultType}"]`)?.classList.add('active');
        showToast('Fault injected');
    }

    // === DRIVE PHYSICS ===
    function updateDrive() {
        if (input.gas) {
            drive.speed = Math.min(drive.speed + drive.acceleration, drive.maxSpeed);
        } else if (input.brake) {
            drive.speed = Math.max(drive.speed - drive.acceleration * 2, -drive.maxSpeed * 0.4);
        } else {
            drive.speed *= 0.97;
            if (Math.abs(drive.speed) < 0.01) drive.speed = 0;
        }

        if (Math.abs(drive.speed) > 0.05) {
            drive.steering = input.joystickX * 0.04 * (drive.speed > 0 ? 1 : -1);
        } else {
            drive.steering = 0;
        }

        state.vehicleGroup.translateZ(drive.speed);
        state.vehicleGroup.rotateY(drive.steering);

        document.getElementById('speedValue').textContent = Math.abs(drive.speed * 50).toFixed(0);
    }

    function updateCamera() {
        const offsets = [
            new THREE.Vector3(0, 20, -50),
            new THREE.Vector3(0, 60, 0),
            new THREE.Vector3(50, 20, 0)
        ];
        const offset = offsets[state.cameraMode];
        const cameraTarget = offset.clone().applyMatrix4(state.vehicleGroup.matrixWorld);
        camera.position.lerp(cameraTarget, 0.1);

        const lookTarget = new THREE.Vector3(0, 5, state.cameraMode === 1 ? 0 : 20);
        lookTarget.applyMatrix4(state.vehicleGroup.matrixWorld);
        camera.lookAt(lookTarget);
    }

    // === TOUCH CONTROLS ===
    const joystick = document.getElementById('joystick');
    const knob = document.getElementById('knob');
    let joystickRect = { cx: 0, cy: 0, radius: 0 };

    function updateJoystickRect() {
        const rect = joystick.getBoundingClientRect();
        joystickRect.cx = rect.left + rect.width / 2;
        joystickRect.cy = rect.top + rect.height / 2;
        joystickRect.radius = rect.width / 2 - 28;
    }

    function handleJoystickMove(clientX, clientY) {
        let dx = clientX - joystickRect.cx;
        let dy = clientY - joystickRect.cy;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist > joystickRect.radius) {
            dx = dx / dist * joystickRect.radius;
            dy = dy / dist * joystickRect.radius;
        }

        input.joystickX = dx / joystickRect.radius;
        input.joystickY = dy / joystickRect.radius;

        knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }

    function resetJoystick() {
        input.joystickActive = false;
        input.joystickX = 0;
        input.joystickY = 0;
        knob.style.transform = 'translate(-50%, -50%)';
    }

    // Touch events
    joystick.addEventListener('touchstart', (e) => {
        e.preventDefault();
        input.joystickActive = true;
        updateJoystickRect();
        handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY);
    });
    joystick.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (input.joystickActive) handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY);
    });
    joystick.addEventListener('touchend', resetJoystick);

    // Mouse events for joystick
    joystick.addEventListener('mousedown', (e) => {
        e.preventDefault();
        input.joystickActive = true;
        updateJoystickRect();
        handleJoystickMove(e.clientX, e.clientY);
    });
    window.addEventListener('mousemove', (e) => {
        if (input.joystickActive) handleJoystickMove(e.clientX, e.clientY);
    });
    window.addEventListener('mouseup', () => {
        if (input.joystickActive) resetJoystick();
    });

    // Pedals - Touch
    const gasBtn = document.getElementById('gasBtn');
    const brakeBtn = document.getElementById('brakeBtn');

    gasBtn.addEventListener('touchstart', (e) => { e.preventDefault(); input.gas = true; gasBtn.classList.add('active'); });
    gasBtn.addEventListener('touchend', () => { input.gas = false; gasBtn.classList.remove('active'); });

    brakeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); input.brake = true; brakeBtn.classList.add('active'); });
    brakeBtn.addEventListener('touchend', () => { input.brake = false; brakeBtn.classList.remove('active'); });

    // Pedals - Mouse
    gasBtn.addEventListener('mousedown', (e) => { e.preventDefault(); input.gas = true; gasBtn.classList.add('active'); });
    gasBtn.addEventListener('mouseup', () => { input.gas = false; gasBtn.classList.remove('active'); });
    gasBtn.addEventListener('mouseleave', () => { input.gas = false; gasBtn.classList.remove('active'); });

    brakeBtn.addEventListener('mousedown', (e) => { e.preventDefault(); input.brake = true; brakeBtn.classList.add('active'); });
    brakeBtn.addEventListener('mouseup', () => { input.brake = false; brakeBtn.classList.remove('active'); });
    brakeBtn.addEventListener('mouseleave', () => { input.brake = false; brakeBtn.classList.remove('active'); });

    // Keyboard support
    window.addEventListener('keydown', (e) => {
        switch (e.key.toLowerCase()) {
            case 'w': case 'arrowup': input.gas = true; break;
            case 's': case 'arrowdown': input.brake = true; break;
            case 'a': case 'arrowleft': input.joystickX = 1; break;
            case 'd': case 'arrowright': input.joystickX = -1; break;
            case 'v': state.cameraMode = (state.cameraMode + 1) % 3; break;
        }
    });
    window.addEventListener('keyup', (e) => {
        switch (e.key.toLowerCase()) {
            case 'w': case 'arrowup': input.gas = false; break;
            case 's': case 'arrowdown': input.brake = false; break;
            case 'a': case 'arrowleft': case 'd': case 'arrowright': input.joystickX = 0; break;
        }
    });

    // Action buttons
    document.getElementById('faultBtn').addEventListener('click', () => {
        document.getElementById('faultPanel').classList.toggle('visible');
    });

    document.getElementById('cameraBtn').addEventListener('click', () => {
        state.cameraMode = (state.cameraMode + 1) % 3;
        showToast('Camera ' + (state.cameraMode + 1));
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        state.vehicleGroup.position.set(0, 0, 0);
        state.vehicleGroup.rotation.set(0, 0, 0);
        drive.speed = 0;
        showToast('Reset');
    });

    document.querySelectorAll('.fault-item').forEach(item => {
        item.addEventListener('click', () => injectFault(item.dataset.fault));
    });

    // === DEVICE SELECTION ===
    const raycaster = new THREE.Raycaster();
    const tapPos = new THREE.Vector2();

    function handleDeviceTap(clientX, clientY) {
        tapPos.x = (clientX / window.innerWidth) * 2 - 1;
        tapPos.y = -(clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(tapPos, camera);
        const intersects = raycaster.intersectObjects(state.vehicleGroup.children, true);

        let device = null;
        for (let hit of intersects) {
            let obj = hit.object;
            while (obj) {
                if (obj.userData && obj.userData.device) {
                    device = obj.userData.device;
                    break;
                }
                obj = obj.parent;
            }
            if (device) break;
        }

        if (device) {
            showProperties(device);
            showToast(`${device.label}`);
        }
    }

    function showProperties(device) {
        const content = document.getElementById('propertiesContent');
        const deviceConns = state.connections.filter(c =>
            c.from.id === device.id || c.to.id === device.id
        );
        const usedPorts = deviceConns.length;
        const totalPorts = templates[device.type].ports || 1;

        let connList = deviceConns.map(c => {
            const other = c.from.id === device.id ? c.to : c.from;
            return `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #e2e8f0;">
                <span style="color:#475569;font-size:11px;">${other.label}</span>
                <span class="badge ${c.bandwidth === '10G' ? 'badge-info' : 'badge-success'}">${c.bandwidth}</span>
            </div>`;
        }).join('');

        content.innerHTML = `
            <div class="prop-section">
                <div class="prop-title">Device Info</div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" value="${device.label}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <input type="text" class="form-input" value="${templates[device.type].label}" readonly>
                </div>
                <div style="margin-top:10px;">
                    <span class="badge ${device.status === 'fault' ? 'badge-danger' : 'badge-success'}">
                        ${device.status === 'fault' ? 'FAULT' : 'Active'}
                    </span>
                </div>
            </div>
            <div class="prop-section">
                <div class="prop-title">Port Usage</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <div style="flex:1;background:#e2e8f0;border-radius:4px;height:6px;overflow:hidden;">
                        <div style="width:${(usedPorts/totalPorts)*100}%;height:100%;background:#3b82f6;"></div>
                    </div>
                    <span style="font-size:11px;font-weight:600;color:#1e293b;">${usedPorts}/${totalPorts}</span>
                </div>
            </div>
            <div class="prop-section">
                <div class="prop-title">Connections (${deviceConns.length})</div>
                <div style="font-size:11px;">
                    ${connList || '<span style="color:#94a3b8;">No connections</span>'}
                </div>
            </div>
        `;
        document.getElementById('properties').classList.add('visible');
    }

    // Tap detection on canvas
    renderer.domElement.addEventListener('click', (e) => {
        // Only handle if not interacting with controls
        if (!input.joystickActive && !input.gas && !input.brake) {
            handleDeviceTap(e.clientX, e.clientY);
        }
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
        document.getElementById('properties').classList.remove('visible');
    });

    // === UI ===
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('visible');
        setTimeout(() => toast.classList.remove('visible'), 2000);
    }

    // === ANIMATION ===
    function animate() {
        requestAnimationFrame(animate);

        updateDrive();
        updateCamera();

        state.connections.forEach(conn => {
            if (conn.status === 'normal') {
                conn.particles.forEach(p => {
                    p.userData.t += 0.012;
                    if (p.userData.t > 1) p.userData.t = 0;
                    p.position.copy(p.userData.curve.getPoint(p.userData.t));
                });
            }
        });

        renderer.render(scene, camera);
    }

    // === INIT ===
    loadScenario();
    animate();

    // Prevent scroll
    document.addEventListener('touchmove', (e) => {
        if (!e.target.closest('.fault-panel')) e.preventDefault();
    }, { passive: false });
    </script>
</body>
</html>
