<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ROii2 Mobile - TSN Network Simulator</title>

    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            width: 100%; height: 100%; overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
        }
        #canvas3d { width: 100%; height: 100%; position: fixed; top: 0; left: 0; }

        .hud { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }

        /* Top Bar - Minimal */
        .top-bar {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .nav-pills {
            display: flex;
            gap: 6px;
            pointer-events: auto;
        }
        .nav-pill {
            padding: 10px 14px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 20px;
            font-size: 11px;
            color: #10b981;
            text-decoration: none;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }
        .nav-pill:hover { background: rgba(16, 185, 129, 0.3); }
        .nav-pill.active { background: #10b981; color: #000; border-color: #10b981; }
        .nav-pill i { margin-right: 4px; }

        .stats-card {
            display: flex;
            gap: 16px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 18px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .stat { text-align: center; }
        .stat-value { font-size: 18px; font-weight: 700; color: #10b981; }
        .stat-label { font-size: 9px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Speedometer - Floating */
        .speedometer {
            position: absolute;
            top: 70px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 16px 24px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(10px);
        }
        .speed-value {
            font-size: 48px;
            font-weight: 700;
            color: #10b981;
            line-height: 1;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        .speed-unit { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px; }

        /* Touch Controls - Modern */
        .touch-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            pointer-events: auto;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
        }

        .joystick-area {
            width: 140px;
            height: 140px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 50%;
            position: relative;
            border: 2px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.1);
        }
        .joystick-knob {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        .pedals {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .pedal {
            width: 100px;
            height: 65px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            gap: 8px;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
        }
        .pedal-gas {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #000;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        .pedal-brake {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }
        .pedal.active { transform: scale(0.92); opacity: 0.8; }

        /* Quick Actions */
        .quick-actions {
            position: absolute;
            left: 50%;
            bottom: 220px;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            pointer-events: auto;
        }
        .quick-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #fff;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }
        .quick-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .quick-btn.active { background: #10b981; color: #000; border-color: #10b981; }
        .quick-btn.danger { color: #ef4444; border-color: rgba(239, 68, 68, 0.4); }
        .quick-btn.danger.active { background: #ef4444; color: #fff; }

        /* Fault Panel - Slide Up */
        .fault-panel {
            position: absolute;
            left: 50%;
            bottom: -300px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            width: 90%;
            max-width: 360px;
            pointer-events: auto;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-bottom: none;
            transition: bottom 0.3s;
            backdrop-filter: blur(20px);
        }
        .fault-panel.visible { bottom: 0; }
        .fault-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .fault-title { font-size: 14px; font-weight: 600; color: #ef4444; display: flex; align-items: center; gap: 8px; }
        .fault-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            cursor: pointer;
        }
        .fault-item {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .fault-item:hover { background: rgba(239, 68, 68, 0.2); }
        .fault-item.active { background: rgba(239, 68, 68, 0.3); border-color: #ef4444; }
        .fault-name { font-size: 13px; font-weight: 600; color: #f87171; }
        .fault-desc { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 4px; }

        /* Properties Panel - Bottom Sheet */
        .properties {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -100%;
            height: 50%;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 24px 24px 0 0;
            transition: bottom 0.3s;
            z-index: 100;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
        }
        .properties.visible { bottom: 0; }
        .properties-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 12px auto;
        }
        .properties-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .properties-title { font-size: 16px; font-weight: 600; color: #fff; }
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
        }
        .properties-content { padding: 20px; overflow-y: auto; flex: 1; }
        .prop-section { margin-bottom: 20px; }
        .prop-title {
            font-size: 11px;
            font-weight: 700;
            color: #10b981;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .prop-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .prop-label { font-size: 13px; color: rgba(255,255,255,0.6); }
        .prop-value { font-size: 13px; font-weight: 600; color: #fff; }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
        }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            padding: 16px 28px;
            background: rgba(16, 185, 129, 0.95);
            color: #000;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* Landscape */
        @media (orientation: landscape) {
            .touch-controls { height: 160px; padding: 16px; }
            .joystick-area { width: 120px; height: 120px; }
            .joystick-knob { width: 50px; height: 50px; }
            .pedal { width: 90px; height: 55px; font-size: 13px; }
            .speedometer { top: 60px; padding: 12px 20px; }
            .speed-value { font-size: 36px; }
            .quick-actions { bottom: 180px; }
            .properties { height: 60%; }
        }

        /* Small screens */
        @media (max-width: 380px) {
            .nav-pills { flex-wrap: wrap; gap: 4px; }
            .nav-pill { padding: 8px 10px; font-size: 10px; }
            .stats-card { padding: 8px 12px; gap: 10px; }
            .stat-value { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div id="canvas3d"></div>

    <div class="hud">
        <div class="top-bar">
            <div class="nav-pills">
                <a href="index.html" class="nav-pill"><i class="fas fa-project-diagram"></i>Network</a>
                <a href="drive.html" class="nav-pill"><i class="fas fa-gamepad"></i>Drive</a>
                <a href="mobile.html" class="nav-pill active"><i class="fas fa-mobile-alt"></i>Mobile</a>
            </div>
            <div class="stats-card">
                <div class="stat">
                    <div class="stat-value" id="deviceCount">0</div>
                    <div class="stat-label">Devices</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="linkCount">0</div>
                    <div class="stat-label">Links</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="bandwidth">0</div>
                    <div class="stat-label">Gbps</div>
                </div>
            </div>
        </div>

        <div class="speedometer">
            <div class="speed-value" id="speedValue">0</div>
            <div class="speed-unit">km/h</div>
        </div>

        <div class="quick-actions">
            <div class="quick-btn danger" id="faultBtn" title="Fault"><i class="fas fa-bolt"></i></div>
            <div class="quick-btn" id="cameraBtn" title="Camera"><i class="fas fa-video"></i></div>
            <div class="quick-btn" id="resetBtn" title="Reset"><i class="fas fa-redo"></i></div>
        </div>

        <div class="touch-controls">
            <div class="joystick-area" id="joystick">
                <div class="joystick-knob" id="knob"></div>
            </div>
            <div class="pedals">
                <button class="pedal pedal-gas" id="gasBtn"><i class="fas fa-chevron-up"></i> GAS</button>
                <button class="pedal pedal-brake" id="brakeBtn"><i class="fas fa-hand-paper"></i> BRAKE</button>
            </div>
        </div>

        <div class="fault-panel" id="faultPanel">
            <div class="fault-header">
                <div class="fault-title"><i class="fas fa-exclamation-triangle"></i> Fault Injection</div>
                <button class="fault-close" id="faultClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="fault-item" data-fault="front-backbone">
                <div class="fault-name">Front 10G Backbone</div>
                <div class="fault-desc">Front-L <i class="fas fa-arrows-alt-h"></i> Front-R link failure</div>
            </div>
            <div class="fault-item" data-fault="front-l-link">
                <div class="fault-name">Front-L <i class="fas fa-arrow-right"></i> HPC</div>
                <div class="fault-desc">Zone controller to HPC link failure</div>
            </div>
            <div class="fault-item" data-fault="sensor">
                <div class="fault-name"><i class="fas fa-satellite-dish"></i> LiDAR-FL Sensor</div>
                <div class="fault-desc">Front-left LiDAR malfunction</div>
            </div>
        </div>

        <div class="properties" id="properties">
            <div class="properties-handle"></div>
            <div class="properties-header">
                <div class="properties-title" id="propsTitle">Device Properties</div>
                <button class="close-btn" id="closeBtn"><i class="fas fa-chevron-down"></i></button>
            </div>
            <div class="properties-content" id="propertiesContent">
                <p style="color: rgba(255,255,255,0.4); text-align: center; padding: 30px;">
                    <i class="fas fa-hand-pointer" style="font-size: 24px; display: block; margin-bottom: 12px;"></i>
                    Tap a device to view
                </p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    // ROii2 Mobile - Dark Infinite Space Version

    // === THREE.JS ===
    const scene = new THREE.Scene();

    // Dark infinite space gradient
    const canvas = document.createElement('canvas');
    canvas.width = 2;
    canvas.height = 1024;
    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 1024);
    gradient.addColorStop(0, '#000000');
    gradient.addColorStop(0.2, '#050510');
    gradient.addColorStop(0.4, '#0a0a1a');
    gradient.addColorStop(0.5, '#0d1020');
    gradient.addColorStop(0.6, '#0a0a1a');
    gradient.addColorStop(0.8, '#050510');
    gradient.addColorStop(1, '#000000');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 2, 1024);
    const skyTexture = new THREE.CanvasTexture(canvas);
    skyTexture.magFilter = THREE.LinearFilter;
    scene.background = skyTexture;

    scene.fog = new THREE.FogExp2(0x050510, 0.004);

    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 500);

    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('canvas3d').appendChild(renderer.domElement);

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // === LIGHTING - Maximum brightness ===
    scene.add(new THREE.AmbientLight(0xFFFFFF, 1.2));
    const mainLight = new THREE.DirectionalLight(0xFFFFFF, 1.5);
    mainLight.position.set(30, 60, 30);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 2048;
    mainLight.shadow.mapSize.height = 2048;
    scene.add(mainLight);

    // Fill light from above
    const fillLight = new THREE.DirectionalLight(0xFFFFFF, 1.0);
    fillLight.position.set(0, 50, 0);
    scene.add(fillLight);

    // === ENVIRONMENT - Infinite Space ===
    // Subtle infinite grid
    const gridMat = new THREE.LineBasicMaterial({ color: 0x10b981, transparent: true, opacity: 0.12 });
    const gridSize = 1500;
    const gridDivisions = 75;
    const gridGeo = new THREE.BufferGeometry();
    const gridPoints = [];
    const step = gridSize / gridDivisions;
    const half = gridSize / 2;

    for (let i = 0; i <= gridDivisions; i++) {
        const pos = -half + i * step;
        gridPoints.push(-half, 0, pos, half, 0, pos);
        gridPoints.push(pos, 0, -half, pos, 0, half);
    }
    gridGeo.setAttribute('position', new THREE.Float32BufferAttribute(gridPoints, 3));
    const grid = new THREE.LineSegments(gridGeo, gridMat);
    grid.position.y = -1;
    scene.add(grid);

    // Floating particles
    const particleCount = 300;
    const particleGeo = new THREE.BufferGeometry();
    const particlePositions = new Float32Array(particleCount * 3);
    for (let i = 0; i < particleCount; i++) {
        particlePositions[i * 3] = (Math.random() - 0.5) * 800;
        particlePositions[i * 3 + 1] = Math.random() * 150;
        particlePositions[i * 3 + 2] = (Math.random() - 0.5) * 800;
    }
    particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
    const particles = new THREE.Points(particleGeo, new THREE.PointsMaterial({
        color: 0x10b981, size: 0.6, transparent: true, opacity: 0.3
    }));
    scene.add(particles);

    // === STATE ===
    const state = {
        vehicleGroup: new THREE.Group(),
        devices: new Map(),
        connections: [],
        deviceCounter: 1,
        activeFaults: new Set(),
        cameraMode: 0
    };
    scene.add(state.vehicleGroup);

    const drive = { speed: 0, maxSpeed: 2.0, acceleration: 0.05, steerInput: 0, steering: 0 };
    const input = { gas: false, brake: false, joystickActive: false, joystickX: 0, joystickY: 0 };

    // === TEMPLATES ===
    const templates = {
        lan9692: { label: 'LAN9692 TSN Switch', color: 0x10b981, size: [4, 2, 4], ports: 12 },
        hpc: { label: 'ACU_IT HPC', color: 0xe11d48, size: [5, 2.5, 5], ports: 4 },
        camera: { label: 'Camera', color: 0xf59e0b, size: [0.8, 0.8, 0.8], ports: 1 },
        lidar: { label: 'LiDAR', color: 0x10b981, size: [1.2, 1.2, 1.2], ports: 1 },
        radar: { label: 'Radar', color: 0x8b5cf6, size: [1.2, 1.2, 1.2], ports: 1 }
    };

    // === VEHICLE ===
    let vehicleMeshes = [];

    function createVehicle() {
        const loader = new THREE.GLTFLoader();
        loader.load('./roii.glb',
            (gltf) => {
                const model = gltf.scene;
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                const scale = 35 / Math.max(size.x, size.y, size.z);
                model.scale.set(scale, scale, scale);
                model.position.set(-center.x, -center.y + size.y * scale * 0.5 + 0.5, -center.z);
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material.transparent = true;
                        child.material.opacity = 0.85;
                        child.material.side = THREE.DoubleSide;
                        child.castShadow = true;
                        // Natural brightness for driving mode
                        if (child.material.color) {
                            child.material.color.multiplyScalar(1.5);
                        }
                        child.material.emissive = new THREE.Color(0x333333);
                        child.material.emissiveIntensity = 0.2;
                        vehicleMeshes.push(child);
                    }
                });
                state.vehicleGroup.add(model);
            },
            null,
            () => createProceduralVehicle()
        );
    }

    function createProceduralVehicle() {
        const chassisMat = new THREE.MeshPhysicalMaterial({
            color: 0x1a1a2e, transparent: true, opacity: 0.8,
            metalness: 0.3, roughness: 0.2, clearcoat: 0.8
        });

        const chassis = new THREE.Mesh(new THREE.BoxGeometry(14, 8, 32), chassisMat);
        chassis.position.y = 5;
        chassis.castShadow = true;
        state.vehicleGroup.add(chassis);
        vehicleMeshes.push(chassis);

        const roof = new THREE.Mesh(new THREE.BoxGeometry(12, 4, 26), chassisMat.clone());
        roof.position.y = 11;
        roof.castShadow = true;
        state.vehicleGroup.add(roof);
        vehicleMeshes.push(roof);

        // Glow lights
        const frontLight = new THREE.Mesh(
            new THREE.BoxGeometry(12, 1.5, 0.3),
            new THREE.MeshBasicMaterial({ color: 0x10b981 })
        );
        frontLight.position.set(0, 5, 16.2);
        state.vehicleGroup.add(frontLight);

        const rearLight = new THREE.Mesh(
            new THREE.BoxGeometry(12, 1.5, 0.3),
            new THREE.MeshBasicMaterial({ color: 0xef4444 })
        );
        rearLight.position.set(0, 5, -16.2);
        state.vehicleGroup.add(rearLight);
    }

    // === DEVICES & CONNECTIONS ===
    function addDevice(type, position, label) {
        const t = templates[type];
        const id = `dev-${state.deviceCounter++}`;
        const device = { id, type, label, position: position.clone(), status: 'normal', mesh: null };

        const geo = type === 'lidar' && !label.includes('Center') ?
            new THREE.CylinderGeometry(t.size[0] * 0.5, t.size[0] * 0.5, t.size[1], 16) :
            new THREE.BoxGeometry(...t.size);

        const mat = new THREE.MeshPhongMaterial({
            color: t.color, emissive: t.color, emissiveIntensity: 0.6, shininess: 50
        });

        const group = new THREE.Group();
        const mesh = new THREE.Mesh(geo, mat);
        mesh.castShadow = true;
        group.add(mesh);
        group.add(new THREE.LineSegments(
            new THREE.EdgesGeometry(geo),
            new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.5, transparent: true })
        ));
        group.position.copy(position);
        group.userData = { device };
        device.mesh = group;

        state.vehicleGroup.add(group);
        state.devices.set(id, device);
        return device;
    }

    function createConnection(from, to) {
        let bw, color, tubeRadius;
        if (from.type === 'lan9692' && to.type === 'lan9692') {
            bw = '10G'; color = 0x3b82f6; tubeRadius = 0.15;
        } else if (from.type === 'hpc' || to.type === 'hpc') {
            bw = '10G'; color = 0xfbbf24; tubeRadius = 0.12;
        } else {
            bw = '1G'; color = 0x10b981; tubeRadius = 0.05;
        }

        const curve = new THREE.CatmullRomCurve3([from.position.clone(), to.position.clone()]);
        const tube = new THREE.Mesh(
            new THREE.TubeGeometry(curve, 12, tubeRadius, 6, false),
            new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.6 })
        );
        state.vehicleGroup.add(tube);

        const particles = [];
        const particleCount = bw === '10G' ? 4 : 2;
        for (let i = 0; i < particleCount; i++) {
            const p = new THREE.Mesh(
                new THREE.SphereGeometry(bw === '10G' ? 0.18 : 0.1, 6, 6),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );
            p.userData = { t: i / particleCount, curve };
            state.vehicleGroup.add(p);
            particles.push(p);
        }

        const conn = { from, to, tube, curve, particles, status: 'normal', originalColor: color, bandwidth: bw };
        state.connections.push(conn);
        return conn;
    }

    function updateConnectionVisual(conn, status) {
        conn.status = status;
        if (status === 'fault') {
            conn.tube.material.color.setHex(0xef4444);
            conn.tube.material.opacity = 0.3;
            conn.particles.forEach(p => p.visible = false);
        } else {
            conn.tube.material.color.setHex(conn.originalColor);
            conn.tube.material.opacity = 0.6;
            conn.particles.forEach(p => p.visible = true);
        }
    }

    // === LOAD SCENARIO ===
    function loadScenario() {
        createVehicle();

        const acuIT = addDevice('hpc', new THREE.Vector3(0, 4, 0), 'ACU_IT');
        const frontL = addDevice('lan9692', new THREE.Vector3(-3.5, 4, 10), 'Front-L-9692');
        const frontR = addDevice('lan9692', new THREE.Vector3(3.5, 4, 10), 'Front-R-9692');
        const rear = addDevice('lan9692', new THREE.Vector3(0, 4, -10), 'Rear-9692');

        // LiDAR (4) - Updated positions
        const lidarFL = addDevice('lidar', new THREE.Vector3(-8.5, 10, 16.2), 'LiDAR-FL');
        const lidarFR = addDevice('lidar', new THREE.Vector3(8.5, 10, 16.2), 'LiDAR-FR');
        const lidarFC = addDevice('lidar', new THREE.Vector3(0, 5.5, 18.5), 'LiDAR-Front-Center');
        const lidarRC = addDevice('lidar', new THREE.Vector3(0, 5.5, -18.5), 'LiDAR-Rear-Center');

        // Camera (8) - Updated positions
        const camFC = addDevice('camera', new THREE.Vector3(0, 10.5, 18.5), 'Cam-Front-Center');
        const camFL = addDevice('camera', new THREE.Vector3(0.6, 10.5, 18.5), 'Cam-Front-L');
        const camFR = addDevice('camera', new THREE.Vector3(-0.6, 10.5, 18.5), 'Cam-Front-R');
        const camSL1 = addDevice('camera', new THREE.Vector3(-8.5, 11, 16.5), 'Cam-Side-L1');
        const camSR1 = addDevice('camera', new THREE.Vector3(8.5, 11, 16.5), 'Cam-Side-R1');
        const camSL2 = addDevice('camera', new THREE.Vector3(-8.5, 11, 15.9), 'Cam-Side-L2');
        const camSR2 = addDevice('camera', new THREE.Vector3(8.5, 11, 15.9), 'Cam-Side-R2');
        const camRC = addDevice('camera', new THREE.Vector3(0, 9, -18.5), 'Cam-Rear-Center');

        // Radar (5) - Updated positions
        const radarFC = addDevice('radar', new THREE.Vector3(0, 7, 18.5), 'Radar-Front-Center');
        const radarFL = addDevice('radar', new THREE.Vector3(-7, 6.5, 17.5), 'Radar-Front-L');
        const radarFR = addDevice('radar', new THREE.Vector3(7, 6.5, 17.5), 'Radar-Front-R');
        const radarRL = addDevice('radar', new THREE.Vector3(-7, 6.5, -18), 'Radar-Rear-L');
        const radarRR = addDevice('radar', new THREE.Vector3(7, 6.5, -18), 'Radar-Rear-R');

        // Connections
        createConnection(frontL, acuIT);
        createConnection(frontR, acuIT);
        createConnection(rear, acuIT);
        createConnection(frontL, frontR);

        createConnection(frontL, lidarFL);
        createConnection(frontL, lidarFC);
        createConnection(frontL, camFL);
        createConnection(frontL, camSL1);
        createConnection(frontL, radarFL);

        createConnection(frontR, lidarFR);
        createConnection(frontR, camFC);
        createConnection(frontR, camFR);
        createConnection(frontR, camSR1);
        createConnection(frontR, radarFC);
        createConnection(frontR, radarFR);

        createConnection(rear, lidarRC);
        createConnection(rear, camRC);
        createConnection(rear, camSL2);
        createConnection(rear, camSR2);
        createConnection(rear, radarRL);
        createConnection(rear, radarRR);

        updateStats();
        showToast('17 Sensors Ready');
    }

    function updateStats() {
        document.getElementById('deviceCount').textContent = state.devices.size;
        document.getElementById('linkCount').textContent = state.connections.length;
        let totalBW = 0;
        state.connections.forEach(c => totalBW += c.bandwidth === '10G' ? 10 : 1);
        document.getElementById('bandwidth').textContent = totalBW;
    }

    // === FAULT SIMULATION ===
    function injectFault(faultType) {
        if (state.activeFaults.has(faultType)) {
            state.activeFaults.delete(faultType);
            state.connections.forEach(conn => updateConnectionVisual(conn, 'normal'));
            state.devices.forEach(d => {
                if (d.label === 'LiDAR-FL' && d.status === 'fault') {
                    d.status = 'normal';
                    d.mesh.children[0].material.color.setHex(templates.lidar.color);
                    d.mesh.children[0].material.emissive.setHex(templates.lidar.color);
                }
            });
            document.querySelector(`[data-fault="${faultType}"]`)?.classList.remove('active');
            showToast('Fault Cleared');
            return;
        }

        state.activeFaults.add(faultType);

        if (faultType === 'sensor') {
            state.devices.forEach(d => {
                if (d.label === 'LiDAR-FL') {
                    d.status = 'fault';
                    d.mesh.children[0].material.color.setHex(0xef4444);
                    d.mesh.children[0].material.emissive.setHex(0xef4444);
                }
            });
        } else {
            state.connections.forEach(conn => {
                let match = false;
                if (faultType === 'front-backbone' &&
                    ((conn.from.label === 'Front-L-9692' && conn.to.label === 'Front-R-9692') ||
                     (conn.from.label === 'Front-R-9692' && conn.to.label === 'Front-L-9692'))) {
                    match = true;
                }
                if (faultType === 'front-l-link' &&
                    ((conn.from.label === 'Front-L-9692' && conn.to.label === 'ACU_IT') ||
                     (conn.from.label === 'ACU_IT' && conn.to.label === 'Front-L-9692'))) {
                    match = true;
                }
                if (match) updateConnectionVisual(conn, 'fault');
            });
        }

        document.querySelector(`[data-fault="${faultType}"]`)?.classList.add('active');
        showToast('Fault Injected');
    }

    // === DRIVING ===
    function updateDrive() {
        if (input.gas) {
            drive.speed = Math.min(drive.speed + drive.acceleration, drive.maxSpeed);
        } else if (input.brake) {
            drive.speed = Math.max(drive.speed - drive.acceleration * 2, -drive.maxSpeed * 0.4);
        } else {
            drive.speed *= 0.97;
            if (Math.abs(drive.speed) < 0.01) drive.speed = 0;
        }

        if (Math.abs(drive.speed) > 0.05) {
            drive.steering = input.joystickX * 0.04 * (drive.speed > 0 ? 1 : -1);
        } else {
            drive.steering = 0;
        }

        state.vehicleGroup.translateZ(drive.speed);
        state.vehicleGroup.rotateY(drive.steering);

        document.getElementById('speedValue').textContent = Math.abs(drive.speed * 50).toFixed(0);
    }

    function updateCamera() {
        const offsets = [
            new THREE.Vector3(0, 20, -50),
            new THREE.Vector3(0, 60, 0),
            new THREE.Vector3(50, 20, 0)
        ];
        const offset = offsets[state.cameraMode];
        const cameraTarget = offset.clone().applyMatrix4(state.vehicleGroup.matrixWorld);
        camera.position.lerp(cameraTarget, 0.1);

        const lookTarget = new THREE.Vector3(0, 5, state.cameraMode === 1 ? 0 : 20);
        lookTarget.applyMatrix4(state.vehicleGroup.matrixWorld);
        camera.lookAt(lookTarget);
    }

    // === TOUCH CONTROLS ===
    const joystick = document.getElementById('joystick');
    const knob = document.getElementById('knob');
    let joystickRect = { cx: 0, cy: 0, radius: 0 };

    function updateJoystickRect() {
        const rect = joystick.getBoundingClientRect();
        joystickRect.cx = rect.left + rect.width / 2;
        joystickRect.cy = rect.top + rect.height / 2;
        joystickRect.radius = rect.width / 2 - 30;
    }

    function handleJoystickMove(clientX, clientY) {
        let dx = clientX - joystickRect.cx;
        let dy = clientY - joystickRect.cy;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist > joystickRect.radius) {
            dx = dx / dist * joystickRect.radius;
            dy = dy / dist * joystickRect.radius;
        }

        input.joystickX = dx / joystickRect.radius;
        input.joystickY = dy / joystickRect.radius;

        knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }

    function resetJoystick() {
        input.joystickActive = false;
        input.joystickX = 0;
        input.joystickY = 0;
        knob.style.transform = 'translate(-50%, -50%)';
    }

    // Touch events
    joystick.addEventListener('touchstart', (e) => {
        e.preventDefault();
        input.joystickActive = true;
        updateJoystickRect();
        handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY);
    });
    joystick.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (input.joystickActive) handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY);
    });
    joystick.addEventListener('touchend', resetJoystick);

    // Mouse events
    joystick.addEventListener('mousedown', (e) => {
        e.preventDefault();
        input.joystickActive = true;
        updateJoystickRect();
        handleJoystickMove(e.clientX, e.clientY);
    });
    window.addEventListener('mousemove', (e) => {
        if (input.joystickActive) handleJoystickMove(e.clientX, e.clientY);
    });
    window.addEventListener('mouseup', () => {
        if (input.joystickActive) resetJoystick();
    });

    // Pedals
    const gasBtn = document.getElementById('gasBtn');
    const brakeBtn = document.getElementById('brakeBtn');

    gasBtn.addEventListener('touchstart', (e) => { e.preventDefault(); input.gas = true; gasBtn.classList.add('active'); });
    gasBtn.addEventListener('touchend', () => { input.gas = false; gasBtn.classList.remove('active'); });
    brakeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); input.brake = true; brakeBtn.classList.add('active'); });
    brakeBtn.addEventListener('touchend', () => { input.brake = false; brakeBtn.classList.remove('active'); });

    gasBtn.addEventListener('mousedown', (e) => { e.preventDefault(); input.gas = true; gasBtn.classList.add('active'); });
    gasBtn.addEventListener('mouseup', () => { input.gas = false; gasBtn.classList.remove('active'); });
    gasBtn.addEventListener('mouseleave', () => { input.gas = false; gasBtn.classList.remove('active'); });
    brakeBtn.addEventListener('mousedown', (e) => { e.preventDefault(); input.brake = true; brakeBtn.classList.add('active'); });
    brakeBtn.addEventListener('mouseup', () => { input.brake = false; brakeBtn.classList.remove('active'); });
    brakeBtn.addEventListener('mouseleave', () => { input.brake = false; brakeBtn.classList.remove('active'); });

    // Keyboard
    window.addEventListener('keydown', (e) => {
        switch (e.key.toLowerCase()) {
            case 'w': case 'arrowup': input.gas = true; break;
            case 's': case 'arrowdown': input.brake = true; break;
            case 'a': case 'arrowleft': input.joystickX = 1; break;
            case 'd': case 'arrowright': input.joystickX = -1; break;
            case 'v': state.cameraMode = (state.cameraMode + 1) % 3; break;
        }
    });
    window.addEventListener('keyup', (e) => {
        switch (e.key.toLowerCase()) {
            case 'w': case 'arrowup': input.gas = false; break;
            case 's': case 'arrowdown': input.brake = false; break;
            case 'a': case 'arrowleft': case 'd': case 'arrowright': input.joystickX = 0; break;
        }
    });

    // === UI EVENTS ===
    document.getElementById('faultBtn').addEventListener('click', () => {
        document.getElementById('faultPanel').classList.toggle('visible');
        document.getElementById('faultBtn').classList.toggle('active');
    });

    document.getElementById('faultClose').addEventListener('click', () => {
        document.getElementById('faultPanel').classList.remove('visible');
        document.getElementById('faultBtn').classList.remove('active');
    });

    document.getElementById('cameraBtn').addEventListener('click', () => {
        state.cameraMode = (state.cameraMode + 1) % 3;
        showToast('Camera ' + (state.cameraMode + 1));
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        state.vehicleGroup.position.set(0, 0, 0);
        state.vehicleGroup.rotation.set(0, 0, 0);
        drive.speed = 0;
        showToast('Reset');
    });

    document.querySelectorAll('.fault-item').forEach(item => {
        item.addEventListener('click', () => injectFault(item.dataset.fault));
    });

    // === DEVICE SELECTION ===
    const raycaster = new THREE.Raycaster();
    const tapPos = new THREE.Vector2();

    function handleDeviceTap(clientX, clientY) {
        tapPos.x = (clientX / window.innerWidth) * 2 - 1;
        tapPos.y = -(clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(tapPos, camera);
        const intersects = raycaster.intersectObjects(state.vehicleGroup.children, true);

        let device = null;
        for (let hit of intersects) {
            let obj = hit.object;
            while (obj) {
                if (obj.userData && obj.userData.device) {
                    device = obj.userData.device;
                    break;
                }
                obj = obj.parent;
            }
            if (device) break;
        }

        if (device) {
            showProperties(device);
        }
    }

    function showProperties(device) {
        const content = document.getElementById('propertiesContent');
        document.getElementById('propsTitle').textContent = device.label;

        const deviceConns = state.connections.filter(c => c.from.id === device.id || c.to.id === device.id);
        const usedPorts = deviceConns.length;
        const totalPorts = templates[device.type].ports || 1;

        let connList = deviceConns.map(c => {
            const other = c.from.id === device.id ? c.to : c.from;
            return `<div class="prop-row">
                <span class="prop-label">${other.label}</span>
                <span class="badge ${c.bandwidth === '10G' ? 'badge-info' : 'badge-success'}">${c.bandwidth}</span>
            </div>`;
        }).join('');

        content.innerHTML = `
            <div class="prop-section">
                <div class="prop-title">Device Info</div>
                <div class="prop-row">
                    <span class="prop-label">Type</span>
                    <span class="prop-value">${templates[device.type].label}</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">Status</span>
                    <span class="badge ${device.status === 'fault' ? 'badge-danger' : 'badge-success'}">
                        ${device.status === 'fault' ? 'FAULT' : 'Active'}
                    </span>
                </div>
            </div>
            <div class="prop-section">
                <div class="prop-title">Port Usage</div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="flex:1;background:rgba(255,255,255,0.1);border-radius:4px;height:8px;overflow:hidden;">
                        <div style="width:${(usedPorts/totalPorts)*100}%;height:100%;background:#10b981;"></div>
                    </div>
                    <span class="prop-value">${usedPorts}/${totalPorts}</span>
                </div>
            </div>
            <div class="prop-section">
                <div class="prop-title">Connections (${deviceConns.length})</div>
                ${connList || '<span style="color:rgba(255,255,255,0.4);">No connections</span>'}
            </div>
        `;
        document.getElementById('properties').classList.add('visible');
    }

    renderer.domElement.addEventListener('click', (e) => {
        if (!input.joystickActive && !input.gas && !input.brake) {
            handleDeviceTap(e.clientX, e.clientY);
        }
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
        document.getElementById('properties').classList.remove('visible');
    });

    // === UI ===
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('visible');
        setTimeout(() => toast.classList.remove('visible'), 2000);
    }

    // === ANIMATION ===
    function animate() {
        requestAnimationFrame(animate);

        updateDrive();
        updateCamera();

        // Infinite grid effect
        const vehiclePos = state.vehicleGroup.position;
        const gridStep = gridSize / gridDivisions;
        grid.position.x = Math.floor(vehiclePos.x / gridStep) * gridStep;
        grid.position.z = Math.floor(vehiclePos.z / gridStep) * gridStep;

        // Particles follow
        particles.position.x = vehiclePos.x * 0.5;
        particles.position.z = vehiclePos.z * 0.5;
        particles.rotation.y += 0.0003;

        state.connections.forEach(conn => {
            if (conn.status === 'normal') {
                conn.particles.forEach(p => {
                    p.userData.t += 0.012;
                    if (p.userData.t > 1) p.userData.t = 0;
                    p.position.copy(p.userData.curve.getPoint(p.userData.t));
                });
            }
        });

        renderer.render(scene, camera);
    }

    // === INIT ===
    loadScenario();
    animate();

    // Prevent scroll
    document.addEventListener('touchmove', (e) => {
        if (!e.target.closest('.fault-panel') && !e.target.closest('.properties-content')) {
            e.preventDefault();
        }
    }, { passive: false });
    </script>
</body>
</html>
