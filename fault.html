<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROii2 - TSN Fault Simulator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-columns: 280px 1fr 380px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 16px;
        }

        .logo-sub {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-primary);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-dot.critical {
            background: var(--accent-red);
            animation: pulse-red 0.5s infinite;
        }

        .status-dot.repairing {
            background: var(--accent-yellow);
            animation: pulse-yellow 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        }

        @keyframes pulse-yellow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .panel {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .panel-title {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title i {
            color: var(--accent-blue);
        }

        /* Fault Injection */
        .fault-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fault-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fault-btn:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            transform: translateX(4px);
        }

        .fault-btn.active {
            background: var(--accent-red);
            border-color: var(--accent-red);
            animation: fault-active 0.5s infinite;
        }

        @keyframes fault-active {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fault-btn i {
            width: 20px;
            text-align: center;
            color: var(--accent-red);
        }

        .fault-btn:hover i, .fault-btn.active i {
            color: white;
        }

        /* Recovery Button */
        .recovery-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .recovery-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .recovery-btn:disabled {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .recovery-btn.processing {
            background: var(--accent-yellow);
        }

        .recovery-btn.processing i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .metric-card {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .metric-label {
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
        }

        .metric-value.danger {
            color: var(--accent-red);
        }

        .metric-value.warning {
            color: var(--accent-yellow);
        }

        .metric-value.success {
            color: var(--accent-green);
        }

        /* Main View */
        .main-view {
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        #canvas3d {
            width: 100%;
            height: 100%;
        }

        /* Overlay Info */
        .overlay-info {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .info-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .info-badge i {
            color: var(--accent-cyan);
        }

        /* Right Panel */
        .right-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Terminal */
        .terminal {
            flex: 1;
            background: #0d1117;
            margin: 16px;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #30363d;
        }

        .terminal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
        }

        .terminal-title {
            font-size: 11px;
            font-weight: 600;
            color: #8b949e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-dots {
            display: flex;
            gap: 6px;
        }

        .terminal-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .terminal-dots span:nth-child(1) { background: #ff5f56; }
        .terminal-dots span:nth-child(2) { background: #ffbd2e; }
        .terminal-dots span:nth-child(3) { background: #27ca40; }

        .terminal-content {
            flex: 1;
            padding: 14px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .log-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 4px;
        }

        .log-time {
            color: #484f58;
            min-width: 65px;
        }

        .log-msg { color: #c9d1d9; }
        .log-msg.info { color: #58a6ff; }
        .log-msg.success { color: #3fb950; }
        .log-msg.error { color: #f85149; font-weight: 600; }
        .log-msg.warning { color: #d29922; }
        .log-msg.cmd { color: #a5d6ff; }
        .log-msg.cmd::before { content: '$ '; color: #484f58; }

        .terminal-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #161b22;
            border-top: 1px solid #30363d;
            font-family: 'SF Mono', monospace;
            font-size: 11px;
        }

        .terminal-input span {
            color: #3fb950;
            font-weight: 600;
        }

        .terminal-cursor {
            width: 7px;
            height: 14px;
            background: #58a6ff;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Chart Panel */
        .chart-panel {
            height: 200px;
            margin: 0 16px 16px;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .chart-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chart-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
        }

        .chart-canvas {
            width: 100%;
            height: 100px;
        }

        /* Network Topology Overlay */
        .topology-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 280px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .topology-title {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .topology-svg {
            width: 100%;
            height: 120px;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s;
        }

        .node:hover {
            filter: brightness(1.2);
        }

        .node-circle {
            fill: var(--bg-secondary);
            stroke: var(--accent-cyan);
            stroke-width: 2;
        }

        .node-circle.fault {
            stroke: var(--accent-red);
            animation: node-fault 0.5s infinite;
        }

        @keyframes node-fault {
            0%, 100% { stroke-width: 2; }
            50% { stroke-width: 4; }
        }

        .node-text {
            fill: var(--text-primary);
            font-size: 8px;
            font-weight: 600;
            text-anchor: middle;
        }

        .link {
            stroke: var(--accent-cyan);
            stroke-width: 2;
            opacity: 0.6;
        }

        .link.fault {
            stroke: var(--accent-red);
            stroke-dasharray: 4 2;
            animation: link-fault 0.3s infinite;
        }

        @keyframes link-fault {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr auto;
            }

            .sidebar, .right-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-network-wired"></i></div>
                <div>
                    <div class="logo-text">ROii2 TSN Fault Simulator</div>
                    <div class="logo-sub">KETI Automotive E/E Platform</div>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">OPERATIONAL</span>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    <i class="fas fa-clock" style="margin-right: 6px;"></i>
                    <span id="currentTime">00:00:00</span>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Fault Injection Panel -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-bolt"></i> Fault Injection</div>
                <div class="fault-buttons">
                    <button class="fault-btn" data-fault="lidar" onclick="injectFault('lidar')">
                        <i class="fas fa-satellite-dish"></i>
                        <span>LiDAR-FL Failure</span>
                    </button>
                    <button class="fault-btn" data-fault="camera" onclick="injectFault('camera')">
                        <i class="fas fa-video"></i>
                        <span>Camera Link Down</span>
                    </button>
                    <button class="fault-btn" data-fault="backbone" onclick="injectFault('backbone')">
                        <i class="fas fa-ethernet"></i>
                        <span>10G Backbone Fault</span>
                    </button>
                    <button class="fault-btn" data-fault="ptp" onclick="injectFault('ptp')">
                        <i class="fas fa-clock"></i>
                        <span>PTP Sync Loss</span>
                    </button>
                    <button class="fault-btn" data-fault="zone" onclick="injectFault('zone')">
                        <i class="fas fa-microchip"></i>
                        <span>Zone Controller Fail</span>
                    </button>
                </div>
            </div>

            <!-- Recovery Panel -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-wrench"></i> Recovery Actions</div>
                <button class="recovery-btn" id="recoveryBtn" onclick="startRecovery()" disabled>
                    <i class="fas fa-sync-alt"></i>
                    <span>Auto-Reconfigure</span>
                </button>
                <div style="margin-top: 10px; font-size: 10px; color: var(--text-secondary); text-align: center;">
                    CORECONF Policy-based Recovery
                </div>
            </div>

            <!-- Metrics Panel -->
            <div class="panel">
                <div class="panel-title"><i class="fas fa-chart-line"></i> Live Metrics</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">PTP Offset</div>
                        <div class="metric-value success" id="ptpValue">0.05 µs</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Packet Loss</div>
                        <div class="metric-value success" id="lossValue">0.00%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">CRC Errors</div>
                        <div class="metric-value success" id="crcValue">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Link Status</div>
                        <div class="metric-value success" id="linkValue">17/17</div>
                    </div>
                </div>
            </div>

            <!-- Device Info -->
            <div class="panel" style="margin-top: auto;">
                <div class="panel-title"><i class="fas fa-microchip"></i> Connected Device</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: var(--bg-secondary); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-server" style="color: var(--accent-cyan);"></i>
                    </div>
                    <div>
                        <div style="font-size: 13px; font-weight: 600;">LAN9662</div>
                        <div style="font-size: 10px; color: var(--text-secondary);">VelocityDRIVE-SP</div>
                    </div>
                    <div style="margin-left: auto; width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%;"></div>
                </div>
            </div>
        </aside>

        <!-- Main 3D View -->
        <main class="main-view">
            <canvas id="canvas3d"></canvas>

            <!-- Overlay Info -->
            <div class="overlay-info">
                <div class="info-badge">
                    <i class="fas fa-car"></i>
                    <span>ROii2 Vehicle Model</span>
                </div>
                <div class="info-badge">
                    <i class="fas fa-sitemap"></i>
                    <span>17 Sensors | 3 Zones | 1 HPC</span>
                </div>
            </div>

            <!-- Network Topology -->
            <div class="topology-overlay">
                <div class="topology-title">Network Topology</div>
                <svg class="topology-svg" viewBox="0 0 250 120">
                    <!-- Links -->
                    <line class="link" id="link-hpc-fl" x1="125" y1="25" x2="50" y2="70"/>
                    <line class="link" id="link-hpc-fr" x1="125" y1="25" x2="200" y2="70"/>
                    <line class="link" id="link-hpc-rear" x1="125" y1="25" x2="125" y2="100"/>
                    <line class="link" id="link-fl-fr" x1="50" y1="70" x2="200" y2="70"/>

                    <!-- Nodes -->
                    <g class="node" id="node-hpc">
                        <circle class="node-circle" cx="125" cy="25" r="18"/>
                        <text class="node-text" x="125" y="28">HPC</text>
                    </g>
                    <g class="node" id="node-fl">
                        <circle class="node-circle" cx="50" cy="70" r="16"/>
                        <text class="node-text" x="50" y="73">FL</text>
                    </g>
                    <g class="node" id="node-fr">
                        <circle class="node-circle" cx="200" cy="70" r="16"/>
                        <text class="node-text" x="200" y="73">FR</text>
                    </g>
                    <g class="node" id="node-rear">
                        <circle class="node-circle" cx="125" cy="100" r="16"/>
                        <text class="node-text" x="125" y="103">REAR</text>
                    </g>

                    <!-- Sensor indicators -->
                    <circle id="sensor-lidar-fl" cx="30" cy="55" r="5" fill="#22c55e"/>
                    <circle id="sensor-cam-fl" cx="40" cy="50" r="4" fill="#3b82f6"/>
                    <circle id="sensor-lidar-fr" cx="220" cy="55" r="5" fill="#22c55e"/>
                    <circle id="sensor-cam-fr" cx="210" cy="50" r="4" fill="#3b82f6"/>
                </svg>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <!-- Chart -->
            <div class="chart-panel">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-wave-square"></i>
                        PTP Clock Offset
                    </div>
                    <div class="chart-value" id="chartValue">0.05 µs</div>
                </div>
                <canvas class="chart-canvas" id="ptpChart"></canvas>
            </div>

            <!-- Terminal -->
            <div class="terminal">
                <div class="terminal-header">
                    <div class="terminal-title">
                        <i class="fas fa-terminal"></i>
                        CORECONF Output
                    </div>
                    <div class="terminal-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
                <div class="terminal-content" id="terminalContent">
                    <!-- Logs will be inserted here -->
                </div>
                <div class="terminal-input">
                    <span>keti@tsn-manager:~$</span>
                    <div class="terminal-cursor"></div>
                </div>
            </div>
        </aside>
    </div>

    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <script>
        // ============================================
        // State Management
        // ============================================
        const state = {
            status: 'normal', // 'normal' | 'critical' | 'repairing'
            activeFaults: new Set(),
            ptpData: [],
            logs: [],
            logId: 0
        };

        // ============================================
        // Three.js Setup
        // ============================================
        const canvas = document.getElementById('canvas3d');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f172a);

        const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(35, 25, 35);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 20;
        controls.maxDistance = 80;
        controls.target.set(0, 5, 0);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404060, 0.5);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffffff, 1);
        mainLight.position.set(20, 40, 20);
        scene.add(mainLight);

        const fillLight = new THREE.DirectionalLight(0x6366f1, 0.3);
        fillLight.position.set(-20, 20, -20);
        scene.add(fillLight);

        // Grid
        const gridHelper = new THREE.GridHelper(100, 50, 0x1e3a5f, 0x0f172a);
        scene.add(gridHelper);

        // ============================================
        // Vehicle & Sensors
        // ============================================
        let vehicle = null;
        const sensors = {};
        const sensorMeshes = [];

        // Sensor positions (from script.js reference)
        const sensorPositions = {
            'LiDAR-FL': { pos: [-8.5, 10, 16.2], type: 'lidar', color: 0x22c55e },
            'LiDAR-FR': { pos: [8.5, 10, 16.2], type: 'lidar', color: 0x22c55e },
            'LiDAR-FC': { pos: [0, 5.5, 18.5], type: 'lidar', color: 0x22c55e },
            'LiDAR-RC': { pos: [0, 5.5, -18.5], type: 'lidar', color: 0x22c55e },
            'Cam-FC': { pos: [0, 10.5, 18.5], type: 'camera', color: 0x3b82f6 },
            'Cam-FL': { pos: [0.6, 10.5, 18.5], type: 'camera', color: 0x3b82f6 },
            'Cam-FR': { pos: [-0.6, 10.5, 18.5], type: 'camera', color: 0x3b82f6 },
            'Cam-SL1': { pos: [-8.5, 11, 16.5], type: 'camera', color: 0x3b82f6 },
            'Cam-SR1': { pos: [8.5, 11, 16.5], type: 'camera', color: 0x3b82f6 },
            'Cam-SL2': { pos: [-8.5, 11, 15.9], type: 'camera', color: 0x3b82f6 },
            'Cam-SR2': { pos: [8.5, 11, 15.9], type: 'camera', color: 0x3b82f6 },
            'Cam-RC': { pos: [0, 9, -18.5], type: 'camera', color: 0x3b82f6 },
            'Radar-FC': { pos: [0, 7, 18.5], type: 'radar', color: 0xeab308 },
            'Radar-FL': { pos: [-7, 6.5, 17.5], type: 'radar', color: 0xeab308 },
            'Radar-FR': { pos: [7, 6.5, 17.5], type: 'radar', color: 0xeab308 },
            'Radar-RL': { pos: [-7, 6.5, -18], type: 'radar', color: 0xeab308 },
            'Radar-RR': { pos: [7, 6.5, -18], type: 'radar', color: 0xeab308 }
        };

        // Load vehicle model
        const loader = new THREE.GLTFLoader();
        loader.load('roii.glb', (gltf) => {
            vehicle = gltf.scene;
            vehicle.scale.set(4, 4, 4);
            vehicle.position.set(0, 0, 0);

            vehicle.traverse((child) => {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({
                        color: 0x1e293b,
                        metalness: 0.8,
                        roughness: 0.3
                    });
                }
            });

            scene.add(vehicle);
            createSensors();
            addLog('info', 'System initialized. ROii2 Vehicle Model loaded.');
            addLog('success', 'VelocityDRIVE-SP Connected (LAN9662).');
            addLog('info', 'YANG Data Model (ietf-interfaces) loaded.');
            addLog('info', 'All 17 sensors online. TSN network operational.');
        });

        function createSensors() {
            Object.entries(sensorPositions).forEach(([name, data]) => {
                const geometry = data.type === 'lidar'
                    ? new THREE.OctahedronGeometry(0.8)
                    : data.type === 'camera'
                    ? new THREE.BoxGeometry(0.6, 0.6, 0.6)
                    : new THREE.ConeGeometry(0.5, 1, 8);

                const material = new THREE.MeshStandardMaterial({
                    color: data.color,
                    emissive: data.color,
                    emissiveIntensity: 0.5,
                    metalness: 0.5,
                    roughness: 0.3
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(...data.pos);
                mesh.name = name;
                mesh.userData = { type: data.type, originalColor: data.color, fault: false };

                scene.add(mesh);
                sensors[name] = mesh;
                sensorMeshes.push(mesh);
            });
        }

        // ============================================
        // Network Connections (Visual Lines)
        // ============================================
        const connectionLines = [];

        function createConnections() {
            const connectionData = [
                { from: [0, 12, 0], to: [-8.5, 10, 16.2], color: 0x06b6d4 }, // HPC to FL zone
                { from: [0, 12, 0], to: [8.5, 10, 16.2], color: 0x06b6d4 },  // HPC to FR zone
                { from: [0, 12, 0], to: [0, 5.5, -18.5], color: 0x06b6d4 },  // HPC to Rear
                { from: [-8.5, 10, 16.2], to: [8.5, 10, 16.2], color: 0x3b82f6 } // FL-FR backbone
            ];

            connectionData.forEach((conn, i) => {
                const points = [
                    new THREE.Vector3(...conn.from),
                    new THREE.Vector3(...conn.to)
                ];
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({
                    color: conn.color,
                    linewidth: 2,
                    transparent: true,
                    opacity: 0.6
                });
                const line = new THREE.Line(geometry, material);
                line.name = `connection-${i}`;
                scene.add(line);
                connectionLines.push(line);
            });
        }

        createConnections();

        // ============================================
        // Fault Injection
        // ============================================
        function injectFault(faultType) {
            if (state.status === 'repairing') return;

            state.status = 'critical';
            state.activeFaults.add(faultType);
            updateStatusUI();

            // Update fault button
            document.querySelector(`[data-fault="${faultType}"]`).classList.add('active');
            document.getElementById('recoveryBtn').disabled = false;

            // Apply visual effects based on fault type
            switch(faultType) {
                case 'lidar':
                    setSensorFault('LiDAR-FL', true);
                    document.getElementById('sensor-lidar-fl').setAttribute('fill', '#ef4444');
                    document.getElementById('node-fl').querySelector('.node-circle').classList.add('fault');
                    addLog('error', 'ALERT: LiDAR-FL sensor failure detected!');
                    addLog('error', 'CRITICAL: Point cloud data loss on Front-Left zone.');
                    addLog('info', 'DIAGNOSIS: Hardware malfunction or interference detected.');
                    break;

                case 'camera':
                    setSensorFault('Cam-FL', true);
                    setSensorFault('Cam-SL1', true);
                    document.getElementById('sensor-cam-fl').setAttribute('fill', '#ef4444');
                    addLog('error', 'ALERT: Camera link down on Front-Left cluster!');
                    addLog('error', 'CRITICAL: Vision processing degraded. Bandwidth: 0 Mbps');
                    addLog('info', 'DIAGNOSIS: MIPI interface error or cable fault.');
                    break;

                case 'backbone':
                    document.getElementById('link-fl-fr').classList.add('fault');
                    connectionLines[3].material.color.setHex(0xef4444);
                    connectionLines[3].material.opacity = 1;
                    addLog('error', 'ALERT: 10G Backbone link instability!');
                    addLog('error', 'CRITICAL: Front-L ↔ Front-R redundancy path FAILED.');
                    addLog('info', 'DIAGNOSIS: SFP+ signal loss or fiber damage.');
                    break;

                case 'ptp':
                    addLog('error', 'ALERT: PTP synchronization lost!');
                    addLog('error', 'CRITICAL: Clock offset exceeded threshold (> 1.0 µs).');
                    addLog('info', 'DIAGNOSIS: Grand Master unreachable. BMC re-election needed.');
                    break;

                case 'zone':
                    document.getElementById('node-fl').querySelector('.node-circle').classList.add('fault');
                    document.getElementById('link-hpc-fl').classList.add('fault');
                    connectionLines[0].material.color.setHex(0xef4444);
                    addLog('error', 'ALERT: Front-L Zone Controller offline!');
                    addLog('error', 'CRITICAL: 5 sensors disconnected from network.');
                    addLog('info', 'DIAGNOSIS: LAN9662 watchdog timeout or power failure.');
                    break;
            }

            updateMetrics();
        }

        function setSensorFault(sensorName, isFault) {
            const sensor = sensors[sensorName];
            if (!sensor) return;

            sensor.userData.fault = isFault;
            if (isFault) {
                sensor.material.color.setHex(0xef4444);
                sensor.material.emissive.setHex(0xef4444);
            } else {
                sensor.material.color.setHex(sensor.userData.originalColor);
                sensor.material.emissive.setHex(sensor.userData.originalColor);
            }
        }

        // ============================================
        // Recovery
        // ============================================
        function startRecovery() {
            if (state.status === 'normal' || state.status === 'repairing') return;

            state.status = 'repairing';
            updateStatusUI();

            const btn = document.getElementById('recoveryBtn');
            btn.classList.add('processing');
            btn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Processing...</span>';

            addLog('info', 'ACTION: Initiating Policy Reconfiguration...');

            setTimeout(() => {
                addLog('cmd', 'keti-ct ipatch policy/auto-recovery.yaml');
            }, 500);

            setTimeout(() => {
                addLog('info', 'INFO: Applying TAS/CBS parameters via CORECONF...');
            }, 1000);

            setTimeout(() => {
                addLog('cmd', 'coreconf set /ietf-interfaces:interfaces/interface[name="swp1"]/enabled true');
            }, 1500);

            setTimeout(() => {
                addLog('info', 'INFO: Re-establishing PTP synchronization...');
            }, 2000);

            setTimeout(() => {
                addLog('cmd', 'ptp4l -i swp1 -m -2 -s');
            }, 2500);

            setTimeout(() => {
                // Reset all faults
                state.activeFaults.forEach(fault => {
                    document.querySelector(`[data-fault="${fault}"]`)?.classList.remove('active');
                });
                state.activeFaults.clear();

                // Reset sensors
                Object.values(sensors).forEach(sensor => {
                    sensor.userData.fault = false;
                    sensor.material.color.setHex(sensor.userData.originalColor);
                    sensor.material.emissive.setHex(sensor.userData.originalColor);
                });

                // Reset topology
                document.querySelectorAll('.node-circle.fault').forEach(el => el.classList.remove('fault'));
                document.querySelectorAll('.link.fault').forEach(el => el.classList.remove('fault'));
                document.getElementById('sensor-lidar-fl').setAttribute('fill', '#22c55e');
                document.getElementById('sensor-cam-fl').setAttribute('fill', '#3b82f6');

                // Reset connection lines
                connectionLines.forEach((line, i) => {
                    line.material.color.setHex(i === 3 ? 0x3b82f6 : 0x06b6d4);
                    line.material.opacity = 0.6;
                });

                state.status = 'normal';
                updateStatusUI();
                updateMetrics();

                btn.classList.remove('processing');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Auto-Reconfigure</span>';
                btn.disabled = true;

                addLog('success', 'SUCCESS: System stabilized. All services operational.');
                addLog('success', 'INFO: TSN network fully recovered. Redundancy paths active.');
            }, 3500);
        }

        // ============================================
        // UI Updates
        // ============================================
        function updateStatusUI() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            dot.classList.remove('critical', 'repairing');

            switch(state.status) {
                case 'normal':
                    text.textContent = 'OPERATIONAL';
                    text.style.color = 'var(--accent-green)';
                    break;
                case 'critical':
                    dot.classList.add('critical');
                    text.textContent = 'CRITICAL';
                    text.style.color = 'var(--accent-red)';
                    break;
                case 'repairing':
                    dot.classList.add('repairing');
                    text.textContent = 'REPAIRING';
                    text.style.color = 'var(--accent-yellow)';
                    break;
            }
        }

        function updateMetrics() {
            const ptpEl = document.getElementById('ptpValue');
            const lossEl = document.getElementById('lossValue');
            const crcEl = document.getElementById('crcValue');
            const linkEl = document.getElementById('linkValue');

            if (state.status === 'critical') {
                ptpEl.textContent = '1.24 µs';
                ptpEl.className = 'metric-value danger';
                lossEl.textContent = '2.45%';
                lossEl.className = 'metric-value danger';
                crcEl.textContent = '1,247';
                crcEl.className = 'metric-value danger';

                const faultCount = state.activeFaults.size;
                const activeLinks = 17 - (faultCount * 2);
                linkEl.textContent = `${activeLinks}/17`;
                linkEl.className = 'metric-value warning';
            } else if (state.status === 'repairing') {
                ptpEl.textContent = '0.42 µs';
                ptpEl.className = 'metric-value warning';
                lossEl.textContent = '0.12%';
                lossEl.className = 'metric-value warning';
                crcEl.textContent = '23';
                crcEl.className = 'metric-value warning';
                linkEl.textContent = '15/17';
                linkEl.className = 'metric-value warning';
            } else {
                ptpEl.textContent = '0.05 µs';
                ptpEl.className = 'metric-value success';
                lossEl.textContent = '0.00%';
                lossEl.className = 'metric-value success';
                crcEl.textContent = '0';
                crcEl.className = 'metric-value success';
                linkEl.textContent = '17/17';
                linkEl.className = 'metric-value success';
            }
        }

        // ============================================
        // Terminal Logging
        // ============================================
        function addLog(type, msg) {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            state.logs.push({ id: state.logId++, time, type, msg });

            const terminal = document.getElementById('terminalContent');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-msg ${type}">${msg}</span>
            `;
            terminal.appendChild(entry);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // ============================================
        // PTP Chart
        // ============================================
        const chartCanvas = document.getElementById('ptpChart');
        const chartCtx = chartCanvas.getContext('2d');
        const chartData = Array(60).fill(0.05);

        function drawChart() {
            const width = chartCanvas.width = chartCanvas.clientWidth * 2;
            const height = chartCanvas.height = chartCanvas.clientHeight * 2;
            chartCtx.scale(2, 2);

            const w = width / 2;
            const h = height / 2;

            chartCtx.clearRect(0, 0, w, h);

            // Grid lines
            chartCtx.strokeStyle = 'rgba(100, 116, 139, 0.1)';
            chartCtx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                const y = (h / 5) * i;
                chartCtx.beginPath();
                chartCtx.moveTo(0, y);
                chartCtx.lineTo(w, y);
                chartCtx.stroke();
            }

            // Data line
            const maxVal = Math.max(...chartData, 0.5);
            chartCtx.beginPath();
            chartCtx.strokeStyle = state.status === 'critical' ? '#ef4444' : '#3b82f6';
            chartCtx.lineWidth = 2;

            chartData.forEach((val, i) => {
                const x = (w / (chartData.length - 1)) * i;
                const y = h - (val / maxVal) * (h - 10);
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            });
            chartCtx.stroke();

            // Fill gradient
            const gradient = chartCtx.createLinearGradient(0, 0, 0, h);
            const color = state.status === 'critical' ? '239, 68, 68' : '59, 130, 246';
            gradient.addColorStop(0, `rgba(${color}, 0.3)`);
            gradient.addColorStop(1, `rgba(${color}, 0)`);

            chartCtx.lineTo(w, h);
            chartCtx.lineTo(0, h);
            chartCtx.closePath();
            chartCtx.fillStyle = gradient;
            chartCtx.fill();
        }

        function updateChartData() {
            let newValue;
            if (state.status === 'critical') {
                newValue = 1.0 + Math.random() * 0.5;
            } else if (state.status === 'repairing') {
                newValue = 0.3 + Math.random() * 0.2;
            } else {
                newValue = 0.03 + Math.random() * 0.04;
            }

            chartData.shift();
            chartData.push(newValue);

            document.getElementById('chartValue').textContent = newValue.toFixed(2) + ' µs';
            document.getElementById('chartValue').style.color =
                state.status === 'critical' ? 'var(--accent-red)' :
                state.status === 'repairing' ? 'var(--accent-yellow)' : 'var(--text-primary)';

            drawChart();
        }

        // ============================================
        // Animation Loop
        // ============================================
        let time = 0;

        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;

            // Sensor pulse animation
            sensorMeshes.forEach(sensor => {
                if (sensor.userData.fault) {
                    sensor.material.emissiveIntensity = 0.5 + Math.sin(time * 10) * 0.5;
                } else {
                    sensor.material.emissiveIntensity = 0.3 + Math.sin(time * 2) * 0.2;
                }
            });

            controls.update();
            renderer.render(scene, camera);
        }

        // ============================================
        // Time & Intervals
        // ============================================
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                now.toLocaleTimeString('en-US', { hour12: false });
        }

        setInterval(updateTime, 1000);
        setInterval(updateChartData, 800);

        // ============================================
        // Resize Handler
        // ============================================
        window.addEventListener('resize', () => {
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });

        // Initialize
        updateTime();
        drawChart();
        animate();
    </script>
</body>
</html>
