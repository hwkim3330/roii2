<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROii2 - TSN Fault Simulator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --border: #e5e5e7;
            --text: #1d1d1f;
            --text-secondary: #86868b;
            --blue: #0071e3;
            --green: #34c759;
            --red: #ff3b30;
            --yellow: #ff9500;
            --purple: #af52de;
            --cyan: #5ac8fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 360px;
            grid-template-rows: 64px 1fr;
            height: 100vh;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo img {
            height: 32px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }

        .logo-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
        }

        .logo-sub {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .status-badge.normal {
            background: rgba(52, 199, 89, 0.1);
            color: var(--green);
        }

        .status-badge.critical {
            background: rgba(255, 59, 48, 0.1);
            color: var(--red);
            animation: critical-pulse 0.5s infinite;
        }

        .status-badge.repairing {
            background: rgba(255, 149, 0, 0.1);
            color: var(--yellow);
        }

        @keyframes critical-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .time-display {
            font-size: 13px;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        /* Sidebar */
        .sidebar {
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .panel {
            background: var(--bg);
            border-radius: 16px;
            padding: 20px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .panel-icon.red { background: rgba(255,59,48,0.1); color: var(--red); }
        .panel-icon.blue { background: rgba(0,113,227,0.1); color: var(--blue); }
        .panel-icon.green { background: rgba(52,199,89,0.1); color: var(--green); }
        .panel-icon.purple { background: rgba(175,82,222,0.1); color: var(--purple); }

        .panel-title {
            font-size: 15px;
            font-weight: 600;
        }

        /* Fault Buttons */
        .fault-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fault-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .fault-btn:hover {
            border-color: var(--red);
            background: rgba(255,59,48,0.02);
        }

        .fault-btn.active {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        .fault-btn i {
            width: 20px;
            color: var(--red);
        }

        .fault-btn.active i {
            color: white;
        }

        .fault-btn span {
            font-size: 13px;
            font-weight: 500;
        }

        /* Recovery Button */
        .recovery-btn {
            width: 100%;
            padding: 16px;
            background: var(--blue);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .recovery-btn:hover {
            background: #0077ed;
            transform: scale(1.02);
        }

        .recovery-btn:disabled {
            background: var(--border);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .recovery-btn.processing {
            background: var(--yellow);
        }

        .recovery-btn.processing i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .metric-item {
            background: var(--card);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 22px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .metric-value.good { color: var(--green); }
        .metric-value.warning { color: var(--yellow); }
        .metric-value.danger { color: var(--red); }

        /* Main View */
        .main-view {
            background: var(--bg);
            position: relative;
        }

        #canvas3d {
            width: 100%;
            height: 100%;
        }

        /* Info Overlay */
        .info-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .info-chip i {
            color: var(--blue);
        }

        /* Topology Panel */
        .topology-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 300px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .topology-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .topology-svg {
            width: 100%;
            height: 140px;
        }

        .topo-node {
            cursor: pointer;
        }

        .topo-node-bg {
            fill: white;
            stroke: var(--border);
            stroke-width: 2;
            transition: all 0.3s;
        }

        .topo-node.fault .topo-node-bg {
            stroke: var(--red);
            stroke-width: 3;
        }

        .topo-node-icon {
            fill: var(--text-secondary);
            font-size: 10px;
        }

        .topo-node-label {
            fill: var(--text);
            font-size: 9px;
            font-weight: 600;
            text-anchor: middle;
        }

        .topo-link {
            stroke: var(--cyan);
            stroke-width: 2;
            opacity: 0.6;
        }

        .topo-link.fault {
            stroke: var(--red);
            stroke-dasharray: 6 3;
            opacity: 1;
            animation: link-flash 0.4s infinite;
        }

        @keyframes link-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .topo-sensor {
            transition: all 0.3s;
        }

        .topo-sensor.fault {
            fill: var(--red) !important;
        }

        /* Right Panel */
        .right-panel {
            background: var(--card);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* Chart Section */
        .chart-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .chart-value {
            font-size: 28px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .chart-canvas-container {
            height: 120px;
            background: var(--bg);
            border-radius: 12px;
            padding: 12px;
        }

        #ptpChart {
            width: 100%;
            height: 100%;
        }

        /* Terminal */
        .terminal-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .terminal-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-badge {
            padding: 3px 8px;
            background: rgba(52,199,89,0.1);
            color: var(--green);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .terminal-content {
            flex: 1;
            padding: 16px 20px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.8;
            background: #fafafa;
        }

        .log-line {
            display: flex;
            gap: 12px;
        }

        .log-time {
            color: #999;
            min-width: 70px;
            font-variant-numeric: tabular-nums;
        }

        .log-msg { color: #333; }
        .log-msg.info { color: var(--blue); }
        .log-msg.success { color: var(--green); }
        .log-msg.error { color: var(--red); font-weight: 600; }
        .log-msg.warning { color: var(--yellow); }
        .log-msg.cmd { color: var(--purple); }
        .log-msg.cmd::before { content: '$ '; color: #999; }

        .terminal-input {
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            background: #fafafa;
        }

        .terminal-prompt {
            color: var(--green);
            font-weight: 600;
        }

        .terminal-cursor {
            width: 8px;
            height: 16px;
            background: var(--blue);
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="keti.png" alt="KETI">
                <div class="logo-divider"></div>
                <span class="logo-text">ROii2</span>
                <span class="logo-sub">TSN Fault Simulator</span>
            </div>
            <div class="status-bar">
                <div class="status-badge normal" id="statusBadge">
                    <div class="status-dot"></div>
                    <span id="statusText">Operational</span>
                </div>
                <div class="time-display" id="timeDisplay">00:00:00</div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Fault Injection -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon red"><i class="fas fa-bolt"></i></div>
                    <div class="panel-title">Fault Injection</div>
                </div>
                <div class="fault-grid">
                    <button class="fault-btn" data-fault="lidar" onclick="injectFault('lidar')">
                        <i class="fas fa-satellite-dish"></i>
                        <span>LiDAR-FL Sensor Failure</span>
                    </button>
                    <button class="fault-btn" data-fault="camera" onclick="injectFault('camera')">
                        <i class="fas fa-video"></i>
                        <span>Camera Link Down</span>
                    </button>
                    <button class="fault-btn" data-fault="backbone" onclick="injectFault('backbone')">
                        <i class="fas fa-network-wired"></i>
                        <span>10G Backbone Fault</span>
                    </button>
                    <button class="fault-btn" data-fault="ptp" onclick="injectFault('ptp')">
                        <i class="fas fa-clock"></i>
                        <span>PTP Sync Loss</span>
                    </button>
                    <button class="fault-btn" data-fault="zone" onclick="injectFault('zone')">
                        <i class="fas fa-microchip"></i>
                        <span>Zone Controller Fail</span>
                    </button>
                </div>
            </div>

            <!-- Recovery -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon blue"><i class="fas fa-wrench"></i></div>
                    <div class="panel-title">Recovery</div>
                </div>
                <button class="recovery-btn" id="recoveryBtn" onclick="startRecovery()" disabled>
                    <i class="fas fa-sync-alt"></i>
                    <span>Auto-Reconfigure</span>
                </button>
            </div>

            <!-- Metrics -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon green"><i class="fas fa-chart-line"></i></div>
                    <div class="panel-title">Live Metrics</div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">PTP Offset</div>
                        <div class="metric-value good" id="metricPTP">0.05µs</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Packet Loss</div>
                        <div class="metric-value good" id="metricLoss">0.00%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">CRC Errors</div>
                        <div class="metric-value good" id="metricCRC">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Link Status</div>
                        <div class="metric-value good" id="metricLink">17/17</div>
                    </div>
                </div>
            </div>

            <!-- Device -->
            <div class="panel" style="margin-top: auto;">
                <div class="panel-header">
                    <div class="panel-icon purple"><i class="fas fa-server"></i></div>
                    <div class="panel-title">Connected Device</div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0;">
                    <div style="font-size: 14px; font-weight: 600;">LAN9662</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">VelocityDRIVE-SP</div>
                    <div style="margin-left: auto; width: 8px; height: 8px; background: var(--green); border-radius: 50%;"></div>
                </div>
            </div>
        </aside>

        <!-- Main 3D View -->
        <main class="main-view">
            <canvas id="canvas3d"></canvas>

            <div class="info-overlay">
                <div class="info-chip">
                    <i class="fas fa-car"></i>
                    ROii2 Vehicle
                </div>
                <div class="info-chip">
                    <i class="fas fa-sitemap"></i>
                    17 Sensors • 3 Zones
                </div>
            </div>

            <!-- Network Topology -->
            <div class="topology-panel">
                <div class="topology-title">Network Topology</div>
                <svg class="topology-svg" viewBox="0 0 260 140">
                    <!-- Links -->
                    <line class="topo-link" id="link-hpc-fl" x1="130" y1="30" x2="50" y2="80"/>
                    <line class="topo-link" id="link-hpc-fr" x1="130" y1="30" x2="210" y2="80"/>
                    <line class="topo-link" id="link-hpc-rear" x1="130" y1="30" x2="130" y2="120"/>
                    <line class="topo-link" id="link-fl-fr" x1="50" y1="80" x2="210" y2="80"/>

                    <!-- HPC Node -->
                    <g class="topo-node" id="node-hpc">
                        <circle class="topo-node-bg" cx="130" cy="30" r="20"/>
                        <text class="topo-node-label" x="130" y="34">HPC</text>
                    </g>

                    <!-- Front-L Node -->
                    <g class="topo-node" id="node-fl">
                        <circle class="topo-node-bg" cx="50" cy="80" r="18"/>
                        <text class="topo-node-label" x="50" y="84">FL</text>
                    </g>

                    <!-- Front-R Node -->
                    <g class="topo-node" id="node-fr">
                        <circle class="topo-node-bg" cx="210" cy="80" r="18"/>
                        <text class="topo-node-label" x="210" y="84">FR</text>
                    </g>

                    <!-- Rear Node -->
                    <g class="topo-node" id="node-rear">
                        <circle class="topo-node-bg" cx="130" cy="120" r="18"/>
                        <text class="topo-node-label" x="130" y="124">REAR</text>
                    </g>

                    <!-- Sensors -->
                    <circle class="topo-sensor" id="topo-lidar-fl" cx="25" cy="60" r="5" fill="#34c759"/>
                    <circle class="topo-sensor" id="topo-cam-fl" cx="35" cy="55" r="4" fill="#5ac8fa"/>
                    <circle class="topo-sensor" id="topo-radar-fl" cx="30" cy="68" r="4" fill="#ff9500"/>

                    <circle class="topo-sensor" id="topo-lidar-fr" cx="235" cy="60" r="5" fill="#34c759"/>
                    <circle class="topo-sensor" id="topo-cam-fr" cx="225" cy="55" r="4" fill="#5ac8fa"/>
                    <circle class="topo-sensor" id="topo-radar-fr" cx="230" cy="68" r="4" fill="#ff9500"/>
                </svg>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <!-- Chart -->
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-title">PTP Clock Offset</div>
                    <div class="chart-value" id="chartValue">0.05 µs</div>
                </div>
                <div class="chart-canvas-container">
                    <canvas id="ptpChart"></canvas>
                </div>
            </div>

            <!-- Terminal -->
            <div class="terminal-section">
                <div class="terminal-header">
                    <div class="terminal-title">
                        <i class="fas fa-terminal"></i>
                        CORECONF Output
                    </div>
                    <div class="terminal-badge">LIVE</div>
                </div>
                <div class="terminal-content" id="terminalContent"></div>
                <div class="terminal-input">
                    <span class="terminal-prompt">keti@tsn:~$</span>
                    <div class="terminal-cursor"></div>
                </div>
            </div>
        </aside>
    </div>

    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <script>
        // ============================================
        // State
        // ============================================
        const state = {
            status: 'normal',
            activeFaults: new Set(),
            logId: 0
        };

        // ============================================
        // Three.js Setup
        // ============================================
        const canvas = document.getElementById('canvas3d');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf5f5f7);

        const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(40, 30, 40);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 25;
        controls.maxDistance = 100;
        controls.target.set(0, 5, 0);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
        mainLight.position.set(30, 50, 30);
        mainLight.castShadow = true;
        scene.add(mainLight);

        const fillLight = new THREE.DirectionalLight(0x87ceeb, 0.3);
        fillLight.position.set(-20, 20, -20);
        scene.add(fillLight);

        // Ground
        const groundGeometry = new THREE.PlaneGeometry(200, 200);
        const groundMaterial = new THREE.MeshStandardMaterial({
            color: 0xeeeeee,
            roughness: 0.9
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Grid
        const gridHelper = new THREE.GridHelper(100, 50, 0xdddddd, 0xeeeeee);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);

        // ============================================
        // Vehicle & Sensors (Matching script.js exactly)
        // ============================================
        let vehicle = null;
        const sensors = {};
        const sensorMeshes = [];

        // Exact sensor positions from script.js
        const sensorConfig = {
            'LiDAR-FL': { pos: [-8.5, 10, 16.2], type: 'lidar', color: 0x34c759 },
            'LiDAR-FR': { pos: [8.5, 10, 16.2], type: 'lidar', color: 0x34c759 },
            'LiDAR-FC': { pos: [0, 5.5, 18.5], type: 'lidar', color: 0x34c759 },
            'LiDAR-RC': { pos: [0, 5.5, -18.5], type: 'lidar', color: 0x34c759 },
            'Cam-FC': { pos: [0, 10.5, 18.5], type: 'camera', color: 0x5ac8fa },
            'Cam-FL': { pos: [0.6, 10.5, 18.5], type: 'camera', color: 0x5ac8fa },
            'Cam-FR': { pos: [-0.6, 10.5, 18.5], type: 'camera', color: 0x5ac8fa },
            'Cam-SL1': { pos: [-8.5, 11, 16.5], type: 'camera', color: 0x5ac8fa },
            'Cam-SR1': { pos: [8.5, 11, 16.5], type: 'camera', color: 0x5ac8fa },
            'Cam-SL2': { pos: [-8.5, 11, 15.9], type: 'camera', color: 0x5ac8fa },
            'Cam-SR2': { pos: [8.5, 11, 15.9], type: 'camera', color: 0x5ac8fa },
            'Cam-RC': { pos: [0, 9, -18.5], type: 'camera', color: 0x5ac8fa },
            'Radar-FC': { pos: [0, 7, 18.5], type: 'radar', color: 0xff9500 },
            'Radar-FL': { pos: [-7, 6.5, 17.5], type: 'radar', color: 0xff9500 },
            'Radar-FR': { pos: [7, 6.5, 17.5], type: 'radar', color: 0xff9500 },
            'Radar-RL': { pos: [-7, 6.5, -18], type: 'radar', color: 0xff9500 },
            'Radar-RR': { pos: [7, 6.5, -18], type: 'radar', color: 0xff9500 }
        };

        // Load vehicle (same logic as script.js)
        const loader = new THREE.GLTFLoader();
        loader.load('roii.glb', (gltf) => {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());

            // Same scaling as script.js
            const targetSize = 40;
            const scale = targetSize / Math.max(size.x, size.y, size.z);
            model.scale.set(scale, scale, scale);

            const scaledHeight = size.y * scale;
            model.position.set(-center.x * scale, -center.y * scale + scaledHeight * 0.5 + 0.5, -center.z * scale);

            model.traverse((child) => {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({
                        color: 0x444444,
                        metalness: 0.6,
                        roughness: 0.4,
                        transparent: true,
                        opacity: 0.85
                    });
                    child.material.color.multiplyScalar(1.5);
                    child.castShadow = true;
                }
            });

            vehicle = model;
            scene.add(vehicle);
            createSensors();

            addLog('info', 'System initialized. ROii2 Vehicle loaded.');
            addLog('success', 'VelocityDRIVE-SP Connected (LAN9662).');
            addLog('info', 'All 17 sensors online. Network operational.');
        });

        function createSensors() {
            Object.entries(sensorConfig).forEach(([name, config]) => {
                let geometry;
                if (config.type === 'lidar') {
                    geometry = new THREE.OctahedronGeometry(0.6);
                } else if (config.type === 'camera') {
                    geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                } else {
                    geometry = new THREE.ConeGeometry(0.4, 0.8, 8);
                }

                const material = new THREE.MeshStandardMaterial({
                    color: config.color,
                    emissive: config.color,
                    emissiveIntensity: 0.3,
                    metalness: 0.5,
                    roughness: 0.3
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(...config.pos);
                mesh.name = name;
                mesh.userData = {
                    type: config.type,
                    originalColor: config.color,
                    fault: false
                };

                scene.add(mesh);
                sensors[name] = mesh;
                sensorMeshes.push(mesh);
            });
        }

        // ============================================
        // Fault Injection
        // ============================================
        function injectFault(faultType) {
            if (state.status === 'repairing') return;

            state.status = 'critical';
            state.activeFaults.add(faultType);
            updateUI();

            document.querySelector(`[data-fault="${faultType}"]`).classList.add('active');
            document.getElementById('recoveryBtn').disabled = false;

            switch(faultType) {
                case 'lidar':
                    setSensorFault('LiDAR-FL', true);
                    document.getElementById('topo-lidar-fl').classList.add('fault');
                    document.getElementById('node-fl').classList.add('fault');
                    addLog('error', 'ALERT: LiDAR-FL sensor failure detected!');
                    addLog('error', 'CRITICAL: Point cloud data loss.');
                    break;

                case 'camera':
                    setSensorFault('Cam-FL', true);
                    setSensorFault('Cam-SL1', true);
                    document.getElementById('topo-cam-fl').classList.add('fault');
                    addLog('error', 'ALERT: Camera link down!');
                    addLog('error', 'CRITICAL: Vision processing degraded.');
                    break;

                case 'backbone':
                    document.getElementById('link-fl-fr').classList.add('fault');
                    addLog('error', 'ALERT: 10G Backbone fault!');
                    addLog('error', 'CRITICAL: Redundancy path FAILED.');
                    break;

                case 'ptp':
                    addLog('error', 'ALERT: PTP sync lost!');
                    addLog('error', 'CRITICAL: Clock offset > 1.0µs.');
                    break;

                case 'zone':
                    document.getElementById('node-fl').classList.add('fault');
                    document.getElementById('link-hpc-fl').classList.add('fault');
                    addLog('error', 'ALERT: Front-L Zone Controller offline!');
                    addLog('error', 'CRITICAL: 5 sensors disconnected.');
                    break;
            }
        }

        function setSensorFault(name, isFault) {
            const sensor = sensors[name];
            if (!sensor) return;

            sensor.userData.fault = isFault;
            sensor.material.color.setHex(isFault ? 0xff3b30 : sensor.userData.originalColor);
            sensor.material.emissive.setHex(isFault ? 0xff3b30 : sensor.userData.originalColor);
        }

        // ============================================
        // Recovery
        // ============================================
        function startRecovery() {
            if (state.status !== 'critical') return;

            state.status = 'repairing';
            updateUI();

            const btn = document.getElementById('recoveryBtn');
            btn.classList.add('processing');
            btn.querySelector('span').textContent = 'Processing...';

            addLog('info', 'Initiating recovery...');
            setTimeout(() => addLog('cmd', 'keti-ct ipatch policy/recovery.yaml'), 500);
            setTimeout(() => addLog('info', 'Applying TAS/CBS parameters...'), 1200);
            setTimeout(() => addLog('cmd', 'ptp4l -i swp1 -m -2 -s'), 2000);

            setTimeout(() => {
                // Reset all
                state.activeFaults.clear();
                state.status = 'normal';

                document.querySelectorAll('.fault-btn.active').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.topo-node.fault').forEach(el => el.classList.remove('fault'));
                document.querySelectorAll('.topo-link.fault').forEach(el => el.classList.remove('fault'));
                document.querySelectorAll('.topo-sensor.fault').forEach(el => el.classList.remove('fault'));

                Object.values(sensors).forEach(s => {
                    s.userData.fault = false;
                    s.material.color.setHex(s.userData.originalColor);
                    s.material.emissive.setHex(s.userData.originalColor);
                });

                btn.classList.remove('processing');
                btn.querySelector('span').textContent = 'Auto-Reconfigure';
                btn.disabled = true;

                updateUI();
                addLog('success', 'System recovered. All services operational.');
            }, 3500);
        }

        // ============================================
        // UI Updates
        // ============================================
        function updateUI() {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');

            badge.className = 'status-badge ' + state.status;

            if (state.status === 'normal') {
                text.textContent = 'Operational';
            } else if (state.status === 'critical') {
                text.textContent = 'Critical';
            } else {
                text.textContent = 'Repairing';
            }

            // Update metrics
            const ptp = document.getElementById('metricPTP');
            const loss = document.getElementById('metricLoss');
            const crc = document.getElementById('metricCRC');
            const link = document.getElementById('metricLink');

            if (state.status === 'critical') {
                ptp.textContent = '1.24µs'; ptp.className = 'metric-value danger';
                loss.textContent = '2.45%'; loss.className = 'metric-value danger';
                crc.textContent = '1,247'; crc.className = 'metric-value danger';
                link.textContent = '12/17'; link.className = 'metric-value warning';
            } else if (state.status === 'repairing') {
                ptp.textContent = '0.42µs'; ptp.className = 'metric-value warning';
                loss.textContent = '0.12%'; loss.className = 'metric-value warning';
                crc.textContent = '23'; crc.className = 'metric-value warning';
                link.textContent = '15/17'; link.className = 'metric-value warning';
            } else {
                ptp.textContent = '0.05µs'; ptp.className = 'metric-value good';
                loss.textContent = '0.00%'; loss.className = 'metric-value good';
                crc.textContent = '0'; crc.className = 'metric-value good';
                link.textContent = '17/17'; link.className = 'metric-value good';
            }
        }

        // ============================================
        // Logging
        // ============================================
        function addLog(type, msg) {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const terminal = document.getElementById('terminalContent');
            const line = document.createElement('div');
            line.className = 'log-line';
            line.innerHTML = `<span class="log-time">${time}</span><span class="log-msg ${type}">${msg}</span>`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // ============================================
        // Chart
        // ============================================
        const chartCanvas = document.getElementById('ptpChart');
        const chartCtx = chartCanvas.getContext('2d');
        const chartData = Array(50).fill(0.05);

        function drawChart() {
            const w = chartCanvas.width = chartCanvas.clientWidth * 2;
            const h = chartCanvas.height = chartCanvas.clientHeight * 2;
            chartCtx.scale(2, 2);

            const width = w / 2;
            const height = h / 2;

            chartCtx.clearRect(0, 0, width, height);

            const maxVal = Math.max(...chartData, 0.5);
            const color = state.status === 'critical' ? '#ff3b30' : '#0071e3';

            // Line
            chartCtx.beginPath();
            chartCtx.strokeStyle = color;
            chartCtx.lineWidth = 2;

            chartData.forEach((val, i) => {
                const x = (width / (chartData.length - 1)) * i;
                const y = height - (val / maxVal) * (height - 8);
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            });
            chartCtx.stroke();

            // Fill
            chartCtx.lineTo(width, height);
            chartCtx.lineTo(0, height);
            chartCtx.closePath();

            const gradient = chartCtx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, color + '40');
            gradient.addColorStop(1, color + '00');
            chartCtx.fillStyle = gradient;
            chartCtx.fill();
        }

        function updateChart() {
            let val;
            if (state.status === 'critical') val = 1.0 + Math.random() * 0.5;
            else if (state.status === 'repairing') val = 0.3 + Math.random() * 0.2;
            else val = 0.03 + Math.random() * 0.04;

            chartData.shift();
            chartData.push(val);

            const chartValue = document.getElementById('chartValue');
            chartValue.textContent = val.toFixed(2) + ' µs';
            chartValue.style.color = state.status === 'critical' ? '#ff3b30' : '#1d1d1f';

            drawChart();
        }

        // ============================================
        // Animation
        // ============================================
        let time = 0;
        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;

            sensorMeshes.forEach(s => {
                if (s.userData.fault) {
                    s.material.emissiveIntensity = 0.3 + Math.sin(time * 10) * 0.3;
                } else {
                    s.material.emissiveIntensity = 0.2 + Math.sin(time * 2) * 0.1;
                }
            });

            controls.update();
            renderer.render(scene, camera);
        }

        // ============================================
        // Init
        // ============================================
        function updateTime() {
            document.getElementById('timeDisplay').textContent =
                new Date().toLocaleTimeString('en-US', { hour12: false });
        }

        setInterval(updateTime, 1000);
        setInterval(updateChart, 800);

        window.addEventListener('resize', () => {
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        });

        updateTime();
        drawChart();
        animate();
    </script>
</body>
</html>
